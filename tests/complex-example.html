<!--
This is example is part of this article:

Source: "Demystifying monads in Rust through property-based testing" — Rain.
© Rain 2020–present. Licensed under CC BY-NC-SA 4.0 unless marked otherwise.
URL: https://sunshowers.io/posts/monads-through-pbt/
Accessed: 2025-11-01
-->
<section id="hL.WCag.readability-page-1"><div><p>In programming pedagogy, <a href="https://en.wikipedia.org/wiki/Monad_%28functional_programming%29" rel="nofollow noopener noreferrer">monads</a> have a place as a mystical object from the functional programming world that’s hard to understand and even harder to explain. <rd-annotation id="annotation-Agx1N24B1rLR1eq2ASxCjv" data-annotation-id-value="Agx1N24B1rLR1eq2ASxCjv" data-annotation-color="yellow">The stereotype about monad explanations is that they fall into two buckets: either comparisons to some kind of </rd-annotation><a href="https://blog.plover.com/prog/burritos.html" rel="nofollow noopener noreferrer"><rd-annotation data-annotation-id-value="Agx1N24B1rLR1eq2ASxCjv" data-annotation-color="yellow">food item</rd-annotation></a><rd-annotation data-annotation-id-value="Agx1N24B1rLR1eq2ASxCjv" data-annotation-color="yellow">, or throwing complex mathematical jargon at you, </rd-annotation><a href="https://stackoverflow.com/questions/3870088/a-monad-is-just-a-monoid-in-the-category-of-endofunctors-whats-the-problem" rel="nofollow noopener noreferrer"><em><rd-annotation data-annotation-id-value="Agx1N24B1rLR1eq2ASxCjv" data-annotation-color="yellow">what’s the problem?</rd-annotation></em></a></p><p><rd-annotation id="annotation-71cEPLrjSGG1vX5xmakgDS" data-annotation-id-value="71cEPLrjSGG1vX5xmakgDS" data-annotation-color="green">But monads aren’t esoteric or magical at all, nor do they only occur in functional programming. In essence, a monad is a </rd-annotation><em><rd-annotation data-annotation-id-value="71cEPLrjSGG1vX5xmakgDS" data-annotation-color="green">design pattern</rd-annotation></em><rd-annotation data-annotation-id-value="71cEPLrjSGG1vX5xmakgDS" data-annotation-color="green"> that allows you to chain together operations within a framework. Noticing monadic design can be quite helpful for programmers in any environment, particularly because it’s often </rd-annotation><strong><rd-annotation data-annotation-id-value="71cEPLrjSGG1vX5xmakgDS" data-annotation-color="green">undesirable</rd-annotation></strong><rd-annotation data-annotation-id-value="71cEPLrjSGG1vX5xmakgDS" data-annotation-color="green">! In many situations, monads have observable tradeoffs, and sometimes (as here) we can even collect concrete data to back this up.</rd-annotation></p><p>I’m going to try and explain monads in a way that is:</p><ul><li><strong>Geared towards Rust developers</strong>, with code samples in Rust, though I hope any sufficiently curious programmer can follow along</li><li><strong>Free of jargon:</strong> no mathematical formalism whatsoever</li><li><strong>Without analogies</strong> of any kind, and grounded in real programming problems</li><li><strong>Non-trivial:</strong> focusing on a production-worthy example with objectively measurable implications</li><li><strong>Practical:</strong> with advice all of us coders can use</li></ul><p>In other words, I’m going to try and write the monad tutorial that I personally would have appreciated when I was younger. And I’m going to start at a place that’s unconventional: through <em>property-based testing</em>, where monads have profound performance characteristics.</p><p><em>Note: While this article’s primary goal is to explain monads, it also serves as a practical introduction to property-based testing and fault injection techniques. If you’re new to these, you’ll find an introduction to both alongside the monad explanation.</em></p><p>This post consists of five sections:</p><ol><li><a href="https://sunshowers.io/posts/monads-through-pbt/%231-property-based-testing" rel="nofollow noopener noreferrer"><em>Property-based testing</em></a> goes over the basics</li><li><a href="https://sunshowers.io/posts/monads-through-pbt/%232-drawing-the-rest-of-the-owl" rel="nofollow noopener noreferrer"><em>Drawing the rest of the owl</em></a> talks about a complex scenario: using property-based testing to inject faults</li><li><a href="https://sunshowers.io/posts/monads-through-pbt/%233-integrated-shrinking" rel="nofollow noopener noreferrer"><em>Integrated shrinking</em></a> shows how to reduce inputs of challenging complexity to smaller sizes</li><li><a href="https://sunshowers.io/posts/monads-through-pbt/%234-monads-finally" rel="nofollow noopener noreferrer"><em>Monads, finally</em></a> is where we introduce monads in this context, and provide data for how costly they can be</li><li><a href="https://sunshowers.io/posts/monads-through-pbt/%235-rediscovering-structure" rel="nofollow noopener noreferrer"><em>Rediscovering structure</em></a> discusses some ways to mitigate the tradeoffs of monads in property-based testing</li></ol><h2 id="hL.WCag.1-property-based-testing"><rd-annotation id="annotation-NFfadeagHVwvYqiaBNdEYt" data-annotation-id-value="NFfadeagHVwvYqiaBNdEYt" data-annotation-color="yellow">1. Property-based testing</rd-annotation><a href="#hL.WCag.1-property-based-testing" arialabel="Anchor" rel="nofollow noopener noreferrer">#</a></h2><p><rd-annotation id="annotation-UvvEnqk41GTPxh36jCJPDV" data-annotation-id-value="UvvEnqk41GTPxh36jCJPDV" data-annotation-color="yellow">Testing is fundamentally about building models for how your code should behave, at just the right level of complexity: they should match the scope of what you’re testing, without going overboard and reinventing the whole system a second time.</rd-annotation></p><p>The best explication of this general idea I’ve seen is in <a href="https://kwarc.info/teaching/TDM/Borges.pdf" rel="nofollow noopener noreferrer">this piece</a> by the great Argentinian writer <a href="https://en.wikipedia.org/wiki/Jorge_Luis_Borges" rel="nofollow noopener noreferrer">Jorge Luis Borges</a>:</p><blockquote><p>…In that Empire, the Art of Cartography attained such Perfection that the map of a single Province occupied the entirety of a City, and the map of the Empire, the entirety of a Province. In time, those Unconscionable Maps no longer satisfied, and the Cartographers Guilds struck a Map of the Empire whose size was that of the Empire, and which coincided point for point with it…”</p><p><em>—On Exactitude in Science</em>, Jorge Luis Borges</p></blockquote><p><rd-annotation id="annotation-EKLjrk3zo1otJGmDPQ8GxW" data-annotation-id-value="EKLjrk3zo1otJGmDPQ8GxW" data-annotation-color="green">Nothing quite exemplifies testing-as-modeling like property-based testing—an approach where instead of specifying exact examples, you define models in terms of </rd-annotation><strong><rd-annotation data-annotation-id-value="EKLjrk3zo1otJGmDPQ8GxW" data-annotation-color="green">properties</rd-annotation></strong><rd-annotation data-annotation-id-value="EKLjrk3zo1otJGmDPQ8GxW" data-annotation-color="green">, or invariants, that your code should satisfy. Then, you test your models against randomly generated inputs.</rd-annotation></p><p>Let’s take a simple example of a sort function, say <code>my_sort</code>, defined over a slice of integers:</p><div><pre tabindex="0"><code><span><span><span>fn</span> <span>my_sort</span><span>(</span><span>slice</span>: <span>&amp;</span><span>mut</span><span> </span><span>[</span><span>u64</span><span>])</span><span> </span><span>{</span><span>
</span></span></span><span><span><span>    </span><span>// ...
</span></span></span><span><span><span>}</span><span>
</span></span></span></code></pre></div><p>How should we go about testing it?</p><p>The most common way to do this is to list out a bunch of inputs and ensure they are correctly sorted, through <em>example-based tests</em>.</p><div><pre tabindex="0"><code><span><span><span>#[test]</span><span>
</span></span></span><span><span><span>fn</span> <span>test_my_sort</span><span>()</span><span> </span><span>{</span><span>
</span></span></span><span><span><span>    </span><span>let</span><span> </span><span>mut</span><span> </span><span>input</span><span> </span><span>=</span><span> </span><span>[</span><span>1</span><span>,</span><span> </span><span>2</span><span>,</span><span> </span><span>0</span><span>,</span><span> </span><span>2</span><span>,</span><span> </span><span>0</span><span>,</span><span> </span><span>5</span><span>,</span><span> </span><span>6</span><span>,</span><span> </span><span>9</span><span>,</span><span> </span><span>0</span><span>,</span><span> </span><span>3</span><span>,</span><span> </span><span>1</span><span>];</span><span>
</span></span></span><span><span><span>    </span><span>my_sort</span><span>(</span><span>&amp;</span><span>mut</span><span> </span><span>input</span><span>);</span><span>
</span></span></span><span><span><span>    </span><span>assert_eq!</span><span>(</span><span>input</span><span>,</span><span> </span><span>[</span><span>0</span><span>,</span><span> </span><span>0</span><span>,</span><span> </span><span>0</span><span>,</span><span> </span><span>1</span><span>,</span><span> </span><span>1</span><span>,</span><span> </span><span>2</span><span>,</span><span> </span><span>2</span><span>,</span><span> </span><span>3</span><span>,</span><span> </span><span>5</span><span>,</span><span> </span><span>6</span><span>,</span><span> </span><span>9</span><span>]);</span><span>
</span></span></span><span><span><span>
</span></span></span><span><span><span>    </span><span>// More examples listed out.
</span></span></span><span><span><span>}</span><span>
</span></span></span></code></pre></div><p><rd-annotation id="annotation-YRw82NzyBRuULN54oANbA2" data-annotation-id-value="YRw82NzyBRuULN54oANbA2" data-annotation-color="yellow">Example-based tests are quite valuable, because they are easy to write and quite direct about what happens. But even in a simple example like sorting, it’s easy to imagine cases where your examples don’t quite cover every edge case.</rd-annotation></p><p>How can more edge cases be covered? Well, one way to do so is to step back and ask, what is the sort trying to do? The goal of a sort function is to ensure that all the elements are in ascending order. Can we test that directly?</p><p>The first thing we’d need is to get some inputs to test with. All we care about is a list of numbers here, which <em>seems</em> like it should be easy to generate using a random number generator.</p><p>So maybe we write something like:</p><div><pre tabindex="0"><code><span><span><span>#[test]</span><span>
</span></span></span><span><span><span>fn</span> <span>test_my_sort_2</span><span>()</span><span> </span><span>{</span><span>
</span></span></span><span><span><span>    </span><span>// Run the test 1024 times.
</span></span></span><span><span><span>    </span><span>for</span><span> </span><span>_</span><span> </span><span>in</span><span> </span><span>0</span><span>..</span><span>1024</span><span> </span><span>{</span><span>
</span></span></span><span><span><span>        </span><span>// Generate a random list of, say, 0 to 512 elements, with values
</span></span></span><span><span><span>        </span><span>// between 0 and 10000.
</span></span></span><span><span><span>        </span><span>let</span><span> </span><span>input</span><span> </span><span>=</span><span> </span><span>/* ... */</span><span>;</span><span>
</span></span></span><span><span><span>
</span></span></span><span><span><span>        </span><span>let</span><span> </span><span>mut</span><span> </span><span>output</span><span> </span><span>=</span><span> </span><span>input</span><span>.</span><span>clone</span><span>();</span><span>
</span></span></span><span><span><span>        </span><span>// Call the sort function on it.
</span></span></span><span><span><span>        </span><span>my_sort</span><span>(</span><span>&amp;</span><span>mut</span><span> </span><span>output</span><span>);</span><span>
</span></span></span><span><span><span>
</span></span></span><span><span><span>        </span><span>// Check that all values are in ascending order.
</span></span></span><span><span><span>        </span><span>for</span><span> </span><span>i</span><span> </span><span>in</span><span> </span><span>1</span><span>..</span><span>output</span><span>.</span><span>len</span><span>()</span><span> </span><span>{</span><span>
</span></span></span><span><span><span>            </span><span>assert!</span><span>(</span><span>
</span></span></span><span><span><span>                </span><span>output</span><span>[</span><span>i</span><span> </span><span>-</span><span> </span><span>1</span><span>]</span><span> </span><span>&lt;=</span><span> </span><span>output</span><span>[</span><span>i</span><span>],</span><span>
</span></span></span><span><span><span>                </span><span>&#34;input {input:?} failed at index {i}, output {output:?}&#34;</span><span>,</span><span>
</span></span></span><span><span><span>            </span><span>);</span><span>
</span></span></span><span><span><span>        </span><span>}</span><span>
</span></span></span><span><span><span>    </span><span>}</span><span>
</span></span></span><span><span><span>}</span><span>
</span></span></span></code></pre></div><p>We now have a model of sorting that we’ve written down in code form: any pair of values must be in ascending order. (In this view, example-based tests are also simple models: for input X, the output should be Y.)</p><p>Now, we run the test, and…</p><div><pre tabindex="0"><code><span><span>thread &#39;test_my_sort_2&#39; panicked at tests/tests.rs:33:13:
</span></span><span><span>input [7496, 2087, 6900, 7927, 3840, 3065, 6472, 1186, 6464, 4512, 251, 5591, 3410, 2033, 5367, 2202, 5544, 2434, 6491, 8999, 9818, 2885, 8683, 1201, 6115, 2584, 2473, 6817, 5765, 5196, 9389, 5799, 9012, 293, 38, 1024, 9569, 4654, 7449, 7389, 8088, 5074, 3110, 938, 4944, 3859, 7368, 8978, 7524, 9503, 7406, 7591, 8213, 6445, 7000, 7354, 8967, 5549, 7935, 1866, 4048, 4043, 8905, 3154, 4771, 2364, 3982, 5088, 7317, 233, 3396, 1810, 3022, 9065, 454, 6181, 8257, 9598, 3982, 920, 5880, 4165, 4164, 930, 560, 9062, 5587, 6271, 5878, 2495, 9055, 3877, 4352, 1228, 8287, 8901, 3442, 373, 3635, 5316, 4423, 7688, 7919, 4465, 8991, 7043, 7696, 6875, 1478, 2428, 5127, 6809, 6175, 1415, 7263, 5145, 4153, 876, 1528, 6781, 5627, 6750, 3665, 2567, 6855, 141, 2144, 4491, 9121, 7982, 4131, 6337, 1926, 8797, 9382, 1702, 9559, 3910, 1715, 6661, 269, 4366, 6185, 5616, 365, 808, 4864, 3657, 9574, 3057, 7760, 6375, 2326, 7273, 6303, 7018, 8988, 6271, 988, 7796, 2390, 1689, 4279, 9586, 151, 9738, 3659, 7064, 1529, 8237, 4211, 2272, 8909, 7638] failed at index 173, output [38, 141, 151, 233, 251, 269, 293, 365, 373, 454, 560, 808, 876, 920, 930, 938, 988, 1024, 1186, 1201, 1228, 1415, 1478, 1528, 1529, 1689, 1702, 1715, 1810, 1866, 1926, 2033, 2087, 2144, 2202, 2272, 2326, 2364, 2390, 2428, 2434, 2473, 2495, 2567, 2584, 2885, 3022, 3057, 3065, 3110, 3154, 3396, 3410, 3442, 3635, 3657, 3659, 3665, 3840, 3859, 3877, 3910, 3982, 3982, 4043, 4048, 4131, 4153, 4164, 4165, 4211, 4279, 4352, 4366, 4423, 4465, 4491, 4512, 4654, 4771, 4864, 4944, 5074, 5088, 5127, 5145, 5196, 5316, 5367, 5544, 5549, 5587, 5591, 5616, 5627, 5765, 5799, 5878, 5880, 6115, 6175, 6181, 6185, 6271, 6271, 6303, 6337, 6375, 6445, 6464, 6472, 6491, 6661, 6750, 6781, 6809, 6817, 6855, 6875, 6900, 7000, 7018, 7043, 7064, 7263, 7273, 7317, 7354, 7368, 7389, 7406, 7449, 7496, 7524, 7591, 7638, 7688, 7696, 7760, 7796, 7919, 7927, 7935, 7982, 8088, 8213, 8237, 8257, 8287, 8683, 8797, 8901, 8905, 8909, 8967, 8978, 8988, 8991, 8999, 9012, 9055, 9062, 9065, 9121, 9382, 9389, 9503, 9559, 9569, 9574, 9586, 9598, 9818, 9738]
</span></span><span><span>note: run with `RUST_BACKTRACE=1` environment variable to display a backtrace
</span></span></code></pre></div><p>Whoops, looks like the function has a bug. (Scroll the above example to the right!)</p><p><rd-annotation id="annotation-xj5FX9vJJrvkG3QCKDeYc" data-annotation-id-value="xj5FX9vJJrvkG3QCKDeYc" data-annotation-color="yellow">This example is quite unhelpful and hard to understand! It is possible to use this as an input to debug with, but it is quite painful. If we could use automation to turn this test case into a much smaller one that can still reproduce the bug, debugging becomes significantly easier. The process of doing so is called test case </rd-annotation><strong><rd-annotation data-annotation-id-value="xj5FX9vJJrvkG3QCKDeYc" data-annotation-color="yellow">shrinking</rd-annotation></strong><rd-annotation data-annotation-id-value="xj5FX9vJJrvkG3QCKDeYc" data-annotation-color="yellow"> or </rd-annotation><strong><rd-annotation data-annotation-id-value="xj5FX9vJJrvkG3QCKDeYc" data-annotation-color="yellow">reduction</rd-annotation></strong><rd-annotation data-annotation-id-value="xj5FX9vJJrvkG3QCKDeYc" data-annotation-color="yellow">.</rd-annotation></p><p><rd-annotation id="annotation-Q6U8WYZPoHhcmkZGrWguMe" data-annotation-id-value="Q6U8WYZPoHhcmkZGrWguMe" data-annotation-color="green">To recap—property-based testing consists of two components:</rd-annotation></p><ul><li><rd-annotation data-annotation-id-value="Q6U8WYZPoHhcmkZGrWguMe" data-annotation-color="green">Test case </rd-annotation><strong><rd-annotation data-annotation-id-value="Q6U8WYZPoHhcmkZGrWguMe" data-annotation-color="green">generation</rd-annotation></strong><rd-annotation data-annotation-id-value="Q6U8WYZPoHhcmkZGrWguMe" data-annotation-color="green"> using a source of randomness.</rd-annotation></li><li><rd-annotation data-annotation-id-value="Q6U8WYZPoHhcmkZGrWguMe" data-annotation-color="green">On failing a test, </rd-annotation><strong><rd-annotation data-annotation-id-value="Q6U8WYZPoHhcmkZGrWguMe" data-annotation-color="green">shrinking</rd-annotation></strong><rd-annotation data-annotation-id-value="Q6U8WYZPoHhcmkZGrWguMe" data-annotation-color="green"> it down to a smaller, more understandable size.</rd-annotation></li></ul><h3 id="hL.WCag.implementing-a-manual-shrinker"><rd-annotation id="annotation-LnmiJBHc8suTDa2ngSsXjX" data-annotation-id-value="LnmiJBHc8suTDa2ngSsXjX" data-annotation-color="yellow">Implementing a manual shrinker</rd-annotation><a href="#hL.WCag.implementing-a-manual-shrinker" arialabel="Anchor" rel="nofollow noopener noreferrer">#</a></h3><p><rd-annotation id="annotation-UxJgd8pMUw1ESrVQpfYFhg" data-annotation-id-value="UxJgd8pMUw1ESrVQpfYFhg" data-annotation-color="yellow">What counts as “smaller”? For a list of numbers, ideally we’d be able to minimize both the number of items in the list and the integers themselves. This suggests an algorithm for how to write a shrinker by hand:</rd-annotation></p><ul><li><p><rd-annotation id="annotation-WzPpSRtwh9YfA1mEuirhwo" data-annotation-id-value="WzPpSRtwh9YfA1mEuirhwo" data-annotation-color="yellow">First, try and minimize the size of the list using a binary search algorithm.</rd-annotation> For example:</p><ul><li>Try the first half of the list against the function.</li><li>If that exhibits an error, attempt to recursively shrink this half.</li><li>If that doesn’t work, try it with the last half of the list.</li><li>If neither work or if the list has 1 or fewer elements, move on to the next step.</li></ul></li><li><p><rd-annotation id="annotation-2G3CjD4Mu9jUT6BJXiYsj3" data-annotation-id-value="2G3CjD4Mu9jUT6BJXiYsj3" data-annotation-color="yellow">Once the list has been shrunk, start shrinking the elements within the list, applying binary search to each element.</rd-annotation></p></li></ul><p>After you’re done writing this algorithm, you’re well on your way towards creating the original property-based testing library, <a href="https://en.wikipedia.org/wiki/QuickCheck" rel="nofollow noopener noreferrer">QuickCheck</a>. This approach has you write two functions: a <em>generator</em> and a <em>shrinker</em>.</p><p>With this, you can get much more reasonable-looking output:</p><div><pre tabindex="0"><code><span><span>input [58, 33] failed at index 1, output [58, 33]
</span></span></code></pre></div><p>And for relatively simple cases like lists of integers, this kind of shrinking works quite well!</p><p>But we’re not here to test simple cases. We’re here for the difficult ones.</p><h2 id="hL.WCag.2-drawing-the-rest-of-the-owl"><rd-annotation id="annotation-XvAzC3DX1NDsrah1i5GU6e" data-annotation-id-value="XvAzC3DX1NDsrah1i5GU6e" data-annotation-color="yellow">2. Drawing the rest of the owl</rd-annotation><a href="#hL.WCag.2-drawing-the-rest-of-the-owl" arialabel="Anchor" rel="nofollow noopener noreferrer">#</a></h2><figure id=""><img src="https://readeck.qauz.de/bm/Ls/Ls4P3Q3TgG1ppLpzbAKtfo/_resources/NpFDZPvV6g1LANCHqfSbgN.jpg" alt="A drawing guide with instructions for a front-facing owl face, a side/45° profile view, and a front-facing owl with body. Each series has 6 steps. The instructions are quite helpful, and a subversion of the &#34;draw the rest of the owl&#34; meme." id="" width="1050" height="726" loading="lazy"/><figcaption id="">Subverting the <a href="https://www.reddit.com/r/funny/comments/eccj2/how_to_draw_an_owl/" id="" rel="nofollow noopener noreferrer">meme</a>, we’re going to deal with real-world complexity in this section.</figcaption></figure><p>Most real-world sort implementations don’t just work over a list of integers. They’re written to be polymorphic over anything which can be sorted. In Rust parlance, this means anything that implements the <a href="https://doc.rust-lang.org/std/cmp/trait.Ord.html" rel="nofollow noopener noreferrer"><code>Ord</code></a> trait; and even if not, a <a href="https://doc.rust-lang.org/std/primitive.slice.html%23method.sort_by" rel="nofollow noopener noreferrer">custom comparator function</a> can be provided.</p><p>But <code>Ord</code> can be written by hand, and custom comparators are virtually always written by hand.</p><p>One immediate consequence is that it’s possible that the comparator function says two elements are equal, but they are actually different. In that case, should the order of elements be preserved?</p><ul><li>A sort implementation which preserves the order is called a <strong>stable sort</strong>.</li><li>An implementation which does not is called an <strong>unstable sort</strong>.</li></ul><p>Unstable sorts tend to be faster than stable ones, and there are valid reasons for preferring each at different times. (The Rust standard library has separate implementations for <a href="https://doc.rust-lang.org/std/primitive.slice.html%23method.sort" rel="nofollow noopener noreferrer">stable</a> and <a href="https://doc.rust-lang.org/std/primitive.slice.html%23method.sort_unstable" rel="nofollow noopener noreferrer">unstable</a> sorts.)</p><p>Additionally, hand-written implementations mean <strong>users can make mistakes</strong>! A production-grade sort algorithm must behave reasonably in the face of arbitrary user input, not just in the actual elements being sorted but also in the comparator function (full credit to <a href="https://github.com/Voultapher" rel="nofollow noopener noreferrer">Lukas Bergdoll</a> for his <a href="https://github.com/Voultapher/sort-research-rs/blob/main/writeup/sort_safety/text.md" rel="nofollow noopener noreferrer">extensive research</a> here):</p><ul><li><p><strong>Ord safety:</strong> Users can write a comparator that’s simply incorrect. An easy way is to introduce a difference between ordering and equality, for example by <a href="https://doc.rust-lang.org/std/cmp/enum.Ordering.html%23variant.Less" rel="nofollow noopener noreferrer">returning <code>Ordering::Less</code></a> for two elements that are actually equal. Users could also return different answers for the same comparison when called at different times<sup id="hL.WCag.fnref:1"><a href="#hL.WCag.fn:1" role="doc-noteref" rel="nofollow noopener noreferrer">1</a></sup>.</p></li><li><p><strong>Panic safety:</strong> The comparator can panic in the middle of execution. Since panics <a href="https://doc.rust-lang.org/std/panic/fn.catch_unwind.html" rel="nofollow noopener noreferrer">can be caught</a>, the input should be in some kind of valid state afterwards.</p></li><li><p><strong>Observation safety:</strong> If any of the inputs are mutated by the comparator, those mutations must be carried through to the final output. (With Rust, mutation through shared references is possible via <a href="https://doc.rust-lang.org/book/ch15-05-interior-mutability.html" rel="nofollow noopener noreferrer">interior mutability</a>, as seen in <a href="https://doc.rust-lang.org/std/cell/struct.RefCell.html" rel="nofollow noopener noreferrer"><code>RefCell</code></a> or <a href="https://doc.rust-lang.org/std/sync/struct.Mutex.html" rel="nofollow noopener noreferrer"><code>Mutex</code></a>).</p></li></ul><p>In these cases, completing the sort successfully becomes impossible. But it’s important that we leave the input in a reasonable state.</p><p>How do we go about testing this? <rd-annotation id="annotation-LfXrmsiNX6cudQtPGEZyog" data-annotation-id-value="LfXrmsiNX6cudQtPGEZyog" data-annotation-color="yellow">Trying to think of all the different failure modes seems really hard! But property-based testing can address this need through randomized </rd-annotation><strong><rd-annotation data-annotation-id-value="LfXrmsiNX6cudQtPGEZyog" data-annotation-color="yellow">fault injection</rd-annotation></strong><rd-annotation data-annotation-id-value="LfXrmsiNX6cudQtPGEZyog" data-annotation-color="yellow">.</rd-annotation></p><p><rd-annotation id="annotation-QDqQrAVLCiSyVaAvG4SU6E" data-annotation-id-value="QDqQrAVLCiSyVaAvG4SU6E" data-annotation-color="yellow">Let’s focus on Ord safety for now, with a comparator that flips around the result 20% of the time:</rd-annotation></p><div><pre tabindex="0"><code><span><span><span><rd-annotation id="annotation-MVML5nU4ZZ52zJYEd4zXBZ" data-annotation-id-value="MVML5nU4ZZ52zJYEd4zXBZ" data-annotation-color="yellow">#[derive(Clone, Copy, Debug)]</rd-annotation></span><span><rd-annotation data-annotation-id-value="MVML5nU4ZZ52zJYEd4zXBZ" data-annotation-color="yellow">
</rd-annotation></span></span></span><span><span><span><rd-annotation data-annotation-id-value="MVML5nU4ZZ52zJYEd4zXBZ" data-annotation-color="yellow">enum</rd-annotation></span><rd-annotation data-annotation-id-value="MVML5nU4ZZ52zJYEd4zXBZ" data-annotation-color="yellow"> </rd-annotation><span><rd-annotation data-annotation-id-value="MVML5nU4ZZ52zJYEd4zXBZ" data-annotation-color="yellow">OrdBehavior</rd-annotation></span><span><rd-annotation data-annotation-id-value="MVML5nU4ZZ52zJYEd4zXBZ" data-annotation-color="yellow"> </rd-annotation></span><span><rd-annotation data-annotation-id-value="MVML5nU4ZZ52zJYEd4zXBZ" data-annotation-color="yellow">{</rd-annotation></span><span><rd-annotation data-annotation-id-value="MVML5nU4ZZ52zJYEd4zXBZ" data-annotation-color="yellow">
</rd-annotation></span></span></span><span><span><span><rd-annotation data-annotation-id-value="MVML5nU4ZZ52zJYEd4zXBZ" data-annotation-color="yellow">    </rd-annotation></span><span><rd-annotation data-annotation-id-value="MVML5nU4ZZ52zJYEd4zXBZ" data-annotation-color="yellow">Regular</rd-annotation></span><span><rd-annotation data-annotation-id-value="MVML5nU4ZZ52zJYEd4zXBZ" data-annotation-color="yellow">,</rd-annotation></span><span><rd-annotation data-annotation-id-value="MVML5nU4ZZ52zJYEd4zXBZ" data-annotation-color="yellow">
</rd-annotation></span></span></span><span><span><span><rd-annotation data-annotation-id-value="MVML5nU4ZZ52zJYEd4zXBZ" data-annotation-color="yellow">    </rd-annotation></span><span><rd-annotation data-annotation-id-value="MVML5nU4ZZ52zJYEd4zXBZ" data-annotation-color="yellow">Flipped</rd-annotation></span><span><rd-annotation data-annotation-id-value="MVML5nU4ZZ52zJYEd4zXBZ" data-annotation-color="yellow">,</rd-annotation></span><span><rd-annotation data-annotation-id-value="MVML5nU4ZZ52zJYEd4zXBZ" data-annotation-color="yellow">
</rd-annotation></span></span></span><span><span><span><rd-annotation data-annotation-id-value="MVML5nU4ZZ52zJYEd4zXBZ" data-annotation-color="yellow">}</rd-annotation></span><span><rd-annotation data-annotation-id-value="MVML5nU4ZZ52zJYEd4zXBZ" data-annotation-color="yellow">
</rd-annotation></span></span></span><span><span><span><rd-annotation data-annotation-id-value="MVML5nU4ZZ52zJYEd4zXBZ" data-annotation-color="yellow">
</rd-annotation></span></span></span><span><span><span><rd-annotation data-annotation-id-value="MVML5nU4ZZ52zJYEd4zXBZ" data-annotation-color="yellow">struct</rd-annotation></span><rd-annotation data-annotation-id-value="MVML5nU4ZZ52zJYEd4zXBZ" data-annotation-color="yellow"> </rd-annotation><span><rd-annotation data-annotation-id-value="MVML5nU4ZZ52zJYEd4zXBZ" data-annotation-color="yellow">BadType</rd-annotation></span><span><rd-annotation data-annotation-id-value="MVML5nU4ZZ52zJYEd4zXBZ" data-annotation-color="yellow"> </rd-annotation></span><span><rd-annotation data-annotation-id-value="MVML5nU4ZZ52zJYEd4zXBZ" data-annotation-color="yellow">{</rd-annotation></span><span><rd-annotation data-annotation-id-value="MVML5nU4ZZ52zJYEd4zXBZ" data-annotation-color="yellow">
</rd-annotation></span></span></span><span><span><span><rd-annotation data-annotation-id-value="MVML5nU4ZZ52zJYEd4zXBZ" data-annotation-color="yellow">    </rd-annotation></span><span><rd-annotation data-annotation-id-value="MVML5nU4ZZ52zJYEd4zXBZ" data-annotation-color="yellow">value</rd-annotation></span><rd-annotation data-annotation-id-value="MVML5nU4ZZ52zJYEd4zXBZ" data-annotation-color="yellow">: </rd-annotation><span><rd-annotation data-annotation-id-value="MVML5nU4ZZ52zJYEd4zXBZ" data-annotation-color="yellow">u64</rd-annotation></span><span><rd-annotation data-annotation-id-value="MVML5nU4ZZ52zJYEd4zXBZ" data-annotation-color="yellow">,</rd-annotation></span><span><rd-annotation data-annotation-id-value="MVML5nU4ZZ52zJYEd4zXBZ" data-annotation-color="yellow">
</rd-annotation></span></span></span><span><span><span><rd-annotation data-annotation-id-value="MVML5nU4ZZ52zJYEd4zXBZ" data-annotation-color="yellow">    </rd-annotation></span><span><rd-annotation data-annotation-id-value="MVML5nU4ZZ52zJYEd4zXBZ" data-annotation-color="yellow">ord_behavior</rd-annotation></span><rd-annotation data-annotation-id-value="MVML5nU4ZZ52zJYEd4zXBZ" data-annotation-color="yellow">: </rd-annotation><span><rd-annotation data-annotation-id-value="MVML5nU4ZZ52zJYEd4zXBZ" data-annotation-color="yellow">RefCell</rd-annotation></span><span><rd-annotation data-annotation-id-value="MVML5nU4ZZ52zJYEd4zXBZ" data-annotation-color="yellow">&lt;</rd-annotation></span><span><rd-annotation data-annotation-id-value="MVML5nU4ZZ52zJYEd4zXBZ" data-annotation-color="yellow">Vec</rd-annotation></span><span><rd-annotation data-annotation-id-value="MVML5nU4ZZ52zJYEd4zXBZ" data-annotation-color="yellow">&lt;</rd-annotation></span><span><rd-annotation data-annotation-id-value="MVML5nU4ZZ52zJYEd4zXBZ" data-annotation-color="yellow">OrdBehavior</rd-annotation></span><span><rd-annotation data-annotation-id-value="MVML5nU4ZZ52zJYEd4zXBZ" data-annotation-color="yellow">&gt;&gt;</rd-annotation></span><span><rd-annotation data-annotation-id-value="MVML5nU4ZZ52zJYEd4zXBZ" data-annotation-color="yellow">,</rd-annotation></span><span><rd-annotation data-annotation-id-value="MVML5nU4ZZ52zJYEd4zXBZ" data-annotation-color="yellow">
</rd-annotation></span></span></span><span><span><span><rd-annotation data-annotation-id-value="MVML5nU4ZZ52zJYEd4zXBZ" data-annotation-color="yellow">}</rd-annotation></span><span><rd-annotation data-annotation-id-value="MVML5nU4ZZ52zJYEd4zXBZ" data-annotation-color="yellow">
</rd-annotation></span></span></span><span><span><span><rd-annotation data-annotation-id-value="MVML5nU4ZZ52zJYEd4zXBZ" data-annotation-color="yellow">
</rd-annotation></span></span></span><span><span><span><rd-annotation data-annotation-id-value="MVML5nU4ZZ52zJYEd4zXBZ" data-annotation-color="yellow">impl</rd-annotation></span><span><rd-annotation data-annotation-id-value="MVML5nU4ZZ52zJYEd4zXBZ" data-annotation-color="yellow"> </rd-annotation></span><span><rd-annotation data-annotation-id-value="MVML5nU4ZZ52zJYEd4zXBZ" data-annotation-color="yellow">Ord</rd-annotation></span><span><rd-annotation data-annotation-id-value="MVML5nU4ZZ52zJYEd4zXBZ" data-annotation-color="yellow"> </rd-annotation></span><span><rd-annotation data-annotation-id-value="MVML5nU4ZZ52zJYEd4zXBZ" data-annotation-color="yellow">for</rd-annotation></span><span><rd-annotation data-annotation-id-value="MVML5nU4ZZ52zJYEd4zXBZ" data-annotation-color="yellow"> </rd-annotation></span><span><rd-annotation data-annotation-id-value="MVML5nU4ZZ52zJYEd4zXBZ" data-annotation-color="yellow">BadType</rd-annotation></span><span><rd-annotation data-annotation-id-value="MVML5nU4ZZ52zJYEd4zXBZ" data-annotation-color="yellow"> </rd-annotation></span><span><rd-annotation data-annotation-id-value="MVML5nU4ZZ52zJYEd4zXBZ" data-annotation-color="yellow">{</rd-annotation></span><span><rd-annotation data-annotation-id-value="MVML5nU4ZZ52zJYEd4zXBZ" data-annotation-color="yellow">
</rd-annotation></span></span></span><span><span><span><rd-annotation data-annotation-id-value="MVML5nU4ZZ52zJYEd4zXBZ" data-annotation-color="yellow">    </rd-annotation></span><span><rd-annotation data-annotation-id-value="MVML5nU4ZZ52zJYEd4zXBZ" data-annotation-color="yellow">fn</rd-annotation></span><rd-annotation data-annotation-id-value="MVML5nU4ZZ52zJYEd4zXBZ" data-annotation-color="yellow"> </rd-annotation><span><rd-annotation data-annotation-id-value="MVML5nU4ZZ52zJYEd4zXBZ" data-annotation-color="yellow">cmp</rd-annotation></span><span><rd-annotation data-annotation-id-value="MVML5nU4ZZ52zJYEd4zXBZ" data-annotation-color="yellow">(</rd-annotation></span><span><rd-annotation data-annotation-id-value="MVML5nU4ZZ52zJYEd4zXBZ" data-annotation-color="yellow">&amp;</rd-annotation></span><span><rd-annotation data-annotation-id-value="MVML5nU4ZZ52zJYEd4zXBZ" data-annotation-color="yellow">self</rd-annotation></span><span><rd-annotation data-annotation-id-value="MVML5nU4ZZ52zJYEd4zXBZ" data-annotation-color="yellow">,</rd-annotation></span><span><rd-annotation data-annotation-id-value="MVML5nU4ZZ52zJYEd4zXBZ" data-annotation-color="yellow"> </rd-annotation></span><span><rd-annotation data-annotation-id-value="MVML5nU4ZZ52zJYEd4zXBZ" data-annotation-color="yellow">other</rd-annotation></span><rd-annotation data-annotation-id-value="MVML5nU4ZZ52zJYEd4zXBZ" data-annotation-color="yellow">: </rd-annotation><span><rd-annotation data-annotation-id-value="MVML5nU4ZZ52zJYEd4zXBZ" data-annotation-color="yellow">&amp;</rd-annotation></span><span><rd-annotation data-annotation-id-value="MVML5nU4ZZ52zJYEd4zXBZ" data-annotation-color="yellow">Self</rd-annotation></span><span><rd-annotation data-annotation-id-value="MVML5nU4ZZ52zJYEd4zXBZ" data-annotation-color="yellow">)</rd-annotation></span><span><rd-annotation data-annotation-id-value="MVML5nU4ZZ52zJYEd4zXBZ" data-annotation-color="yellow"> </rd-annotation></span><rd-annotation data-annotation-id-value="MVML5nU4ZZ52zJYEd4zXBZ" data-annotation-color="yellow">-&gt; </rd-annotation><span><rd-annotation data-annotation-id-value="MVML5nU4ZZ52zJYEd4zXBZ" data-annotation-color="yellow">Ordering</rd-annotation></span><span><rd-annotation data-annotation-id-value="MVML5nU4ZZ52zJYEd4zXBZ" data-annotation-color="yellow"> </rd-annotation></span><span><rd-annotation data-annotation-id-value="MVML5nU4ZZ52zJYEd4zXBZ" data-annotation-color="yellow">{</rd-annotation></span><span><rd-annotation data-annotation-id-value="MVML5nU4ZZ52zJYEd4zXBZ" data-annotation-color="yellow">
</rd-annotation></span></span></span><span><span><span><rd-annotation data-annotation-id-value="MVML5nU4ZZ52zJYEd4zXBZ" data-annotation-color="yellow">        </rd-annotation></span><span><rd-annotation data-annotation-id-value="MVML5nU4ZZ52zJYEd4zXBZ" data-annotation-color="yellow">// Get the next behavior from the list.
</rd-annotation></span></span></span><span><span><span><rd-annotation data-annotation-id-value="MVML5nU4ZZ52zJYEd4zXBZ" data-annotation-color="yellow">        </rd-annotation></span><span><rd-annotation data-annotation-id-value="MVML5nU4ZZ52zJYEd4zXBZ" data-annotation-color="yellow">match</rd-annotation></span><span><rd-annotation data-annotation-id-value="MVML5nU4ZZ52zJYEd4zXBZ" data-annotation-color="yellow"> </rd-annotation></span><span><rd-annotation data-annotation-id-value="MVML5nU4ZZ52zJYEd4zXBZ" data-annotation-color="yellow">self</rd-annotation></span><span><rd-annotation data-annotation-id-value="MVML5nU4ZZ52zJYEd4zXBZ" data-annotation-color="yellow">.</rd-annotation></span><span><rd-annotation data-annotation-id-value="MVML5nU4ZZ52zJYEd4zXBZ" data-annotation-color="yellow">ord_behavior</rd-annotation></span><span><rd-annotation data-annotation-id-value="MVML5nU4ZZ52zJYEd4zXBZ" data-annotation-color="yellow">.</rd-annotation></span><span><rd-annotation data-annotation-id-value="MVML5nU4ZZ52zJYEd4zXBZ" data-annotation-color="yellow">borrow_mut</rd-annotation></span><span><rd-annotation data-annotation-id-value="MVML5nU4ZZ52zJYEd4zXBZ" data-annotation-color="yellow">().</rd-annotation></span><span><rd-annotation data-annotation-id-value="MVML5nU4ZZ52zJYEd4zXBZ" data-annotation-color="yellow">pop</rd-annotation></span><span><rd-annotation data-annotation-id-value="MVML5nU4ZZ52zJYEd4zXBZ" data-annotation-color="yellow">()</rd-annotation></span><span><rd-annotation data-annotation-id-value="MVML5nU4ZZ52zJYEd4zXBZ" data-annotation-color="yellow"> </rd-annotation></span><span><rd-annotation data-annotation-id-value="MVML5nU4ZZ52zJYEd4zXBZ" data-annotation-color="yellow">{</rd-annotation></span><span><rd-annotation data-annotation-id-value="MVML5nU4ZZ52zJYEd4zXBZ" data-annotation-color="yellow">
</rd-annotation></span></span></span><span><span><span><rd-annotation data-annotation-id-value="MVML5nU4ZZ52zJYEd4zXBZ" data-annotation-color="yellow">            </rd-annotation></span><span><rd-annotation data-annotation-id-value="MVML5nU4ZZ52zJYEd4zXBZ" data-annotation-color="yellow">Some</rd-annotation></span><span><rd-annotation data-annotation-id-value="MVML5nU4ZZ52zJYEd4zXBZ" data-annotation-color="yellow">(</rd-annotation></span><span><rd-annotation data-annotation-id-value="MVML5nU4ZZ52zJYEd4zXBZ" data-annotation-color="yellow">OrdBehavior</rd-annotation></span><rd-annotation data-annotation-id-value="MVML5nU4ZZ52zJYEd4zXBZ" data-annotation-color="yellow">::</rd-annotation><span><rd-annotation data-annotation-id-value="MVML5nU4ZZ52zJYEd4zXBZ" data-annotation-color="yellow">Regular</rd-annotation></span><span><rd-annotation data-annotation-id-value="MVML5nU4ZZ52zJYEd4zXBZ" data-annotation-color="yellow">)</rd-annotation></span><span><rd-annotation data-annotation-id-value="MVML5nU4ZZ52zJYEd4zXBZ" data-annotation-color="yellow"> </rd-annotation></span><span><rd-annotation data-annotation-id-value="MVML5nU4ZZ52zJYEd4zXBZ" data-annotation-color="yellow">|</rd-annotation></span><span><rd-annotation data-annotation-id-value="MVML5nU4ZZ52zJYEd4zXBZ" data-annotation-color="yellow"> </rd-annotation></span><span><rd-annotation data-annotation-id-value="MVML5nU4ZZ52zJYEd4zXBZ" data-annotation-color="yellow">None</rd-annotation></span><span><rd-annotation data-annotation-id-value="MVML5nU4ZZ52zJYEd4zXBZ" data-annotation-color="yellow"> </rd-annotation></span><span><rd-annotation data-annotation-id-value="MVML5nU4ZZ52zJYEd4zXBZ" data-annotation-color="yellow">=&gt;</rd-annotation></span><span><rd-annotation data-annotation-id-value="MVML5nU4ZZ52zJYEd4zXBZ" data-annotation-color="yellow"> </rd-annotation></span><span><rd-annotation data-annotation-id-value="MVML5nU4ZZ52zJYEd4zXBZ" data-annotation-color="yellow">{</rd-annotation></span><span><rd-annotation data-annotation-id-value="MVML5nU4ZZ52zJYEd4zXBZ" data-annotation-color="yellow">
</rd-annotation></span></span></span><span><span><span><rd-annotation data-annotation-id-value="MVML5nU4ZZ52zJYEd4zXBZ" data-annotation-color="yellow">                </rd-annotation></span><span><rd-annotation data-annotation-id-value="MVML5nU4ZZ52zJYEd4zXBZ" data-annotation-color="yellow">self</rd-annotation></span><span><rd-annotation data-annotation-id-value="MVML5nU4ZZ52zJYEd4zXBZ" data-annotation-color="yellow">.</rd-annotation></span><span><rd-annotation data-annotation-id-value="MVML5nU4ZZ52zJYEd4zXBZ" data-annotation-color="yellow">value</rd-annotation></span><span><rd-annotation data-annotation-id-value="MVML5nU4ZZ52zJYEd4zXBZ" data-annotation-color="yellow">.</rd-annotation></span><span><rd-annotation data-annotation-id-value="MVML5nU4ZZ52zJYEd4zXBZ" data-annotation-color="yellow">cmp</rd-annotation></span><span><rd-annotation data-annotation-id-value="MVML5nU4ZZ52zJYEd4zXBZ" data-annotation-color="yellow">(</rd-annotation></span><span><rd-annotation data-annotation-id-value="MVML5nU4ZZ52zJYEd4zXBZ" data-annotation-color="yellow">&amp;</rd-annotation></span><span><rd-annotation data-annotation-id-value="MVML5nU4ZZ52zJYEd4zXBZ" data-annotation-color="yellow">other</rd-annotation></span><span><rd-annotation data-annotation-id-value="MVML5nU4ZZ52zJYEd4zXBZ" data-annotation-color="yellow">.</rd-annotation></span><span><rd-annotation data-annotation-id-value="MVML5nU4ZZ52zJYEd4zXBZ" data-annotation-color="yellow">value</rd-annotation></span><span><rd-annotation data-annotation-id-value="MVML5nU4ZZ52zJYEd4zXBZ" data-annotation-color="yellow">)</rd-annotation></span><span><rd-annotation data-annotation-id-value="MVML5nU4ZZ52zJYEd4zXBZ" data-annotation-color="yellow">
</rd-annotation></span></span></span><span><span><span><rd-annotation data-annotation-id-value="MVML5nU4ZZ52zJYEd4zXBZ" data-annotation-color="yellow">            </rd-annotation></span><span><rd-annotation data-annotation-id-value="MVML5nU4ZZ52zJYEd4zXBZ" data-annotation-color="yellow">}</rd-annotation></span><span><rd-annotation data-annotation-id-value="MVML5nU4ZZ52zJYEd4zXBZ" data-annotation-color="yellow">
</rd-annotation></span></span></span><span><span><span><rd-annotation data-annotation-id-value="MVML5nU4ZZ52zJYEd4zXBZ" data-annotation-color="yellow">            </rd-annotation></span><span><rd-annotation data-annotation-id-value="MVML5nU4ZZ52zJYEd4zXBZ" data-annotation-color="yellow">OrdBehavior</rd-annotation></span><rd-annotation data-annotation-id-value="MVML5nU4ZZ52zJYEd4zXBZ" data-annotation-color="yellow">::</rd-annotation><span><rd-annotation data-annotation-id-value="MVML5nU4ZZ52zJYEd4zXBZ" data-annotation-color="yellow">Flipped</rd-annotation></span><span><rd-annotation data-annotation-id-value="MVML5nU4ZZ52zJYEd4zXBZ" data-annotation-color="yellow"> </rd-annotation></span><span><rd-annotation data-annotation-id-value="MVML5nU4ZZ52zJYEd4zXBZ" data-annotation-color="yellow">=&gt;</rd-annotation></span><span><rd-annotation data-annotation-id-value="MVML5nU4ZZ52zJYEd4zXBZ" data-annotation-color="yellow"> </rd-annotation></span><span><rd-annotation data-annotation-id-value="MVML5nU4ZZ52zJYEd4zXBZ" data-annotation-color="yellow">{</rd-annotation></span><span><rd-annotation data-annotation-id-value="MVML5nU4ZZ52zJYEd4zXBZ" data-annotation-color="yellow">
</rd-annotation></span></span></span><span><span><span><rd-annotation data-annotation-id-value="MVML5nU4ZZ52zJYEd4zXBZ" data-annotation-color="yellow">                </rd-annotation></span><span><rd-annotation data-annotation-id-value="MVML5nU4ZZ52zJYEd4zXBZ" data-annotation-color="yellow">// Flip the behavior.
</rd-annotation></span></span></span><span><span><span><rd-annotation data-annotation-id-value="MVML5nU4ZZ52zJYEd4zXBZ" data-annotation-color="yellow">                </rd-annotation></span><span><rd-annotation data-annotation-id-value="MVML5nU4ZZ52zJYEd4zXBZ" data-annotation-color="yellow">other</rd-annotation></span><span><rd-annotation data-annotation-id-value="MVML5nU4ZZ52zJYEd4zXBZ" data-annotation-color="yellow">.</rd-annotation></span><span><rd-annotation data-annotation-id-value="MVML5nU4ZZ52zJYEd4zXBZ" data-annotation-color="yellow">value</rd-annotation></span><span><rd-annotation data-annotation-id-value="MVML5nU4ZZ52zJYEd4zXBZ" data-annotation-color="yellow">.</rd-annotation></span><span><rd-annotation data-annotation-id-value="MVML5nU4ZZ52zJYEd4zXBZ" data-annotation-color="yellow">cmp</rd-annotation></span><span><rd-annotation data-annotation-id-value="MVML5nU4ZZ52zJYEd4zXBZ" data-annotation-color="yellow">(</rd-annotation></span><span><rd-annotation data-annotation-id-value="MVML5nU4ZZ52zJYEd4zXBZ" data-annotation-color="yellow">&amp;</rd-annotation></span><span><rd-annotation data-annotation-id-value="MVML5nU4ZZ52zJYEd4zXBZ" data-annotation-color="yellow">self</rd-annotation></span><span><rd-annotation data-annotation-id-value="MVML5nU4ZZ52zJYEd4zXBZ" data-annotation-color="yellow">.</rd-annotation></span><span><rd-annotation data-annotation-id-value="MVML5nU4ZZ52zJYEd4zXBZ" data-annotation-color="yellow">value</rd-annotation></span><span><rd-annotation data-annotation-id-value="MVML5nU4ZZ52zJYEd4zXBZ" data-annotation-color="yellow">)</rd-annotation></span><span><rd-annotation data-annotation-id-value="MVML5nU4ZZ52zJYEd4zXBZ" data-annotation-color="yellow">
</rd-annotation></span></span></span><span><span><span><rd-annotation data-annotation-id-value="MVML5nU4ZZ52zJYEd4zXBZ" data-annotation-color="yellow">            </rd-annotation></span><span><rd-annotation data-annotation-id-value="MVML5nU4ZZ52zJYEd4zXBZ" data-annotation-color="yellow">}</rd-annotation></span><span><rd-annotation data-annotation-id-value="MVML5nU4ZZ52zJYEd4zXBZ" data-annotation-color="yellow">
</rd-annotation></span></span></span><span><span><span><rd-annotation data-annotation-id-value="MVML5nU4ZZ52zJYEd4zXBZ" data-annotation-color="yellow">        </rd-annotation></span><span><rd-annotation data-annotation-id-value="MVML5nU4ZZ52zJYEd4zXBZ" data-annotation-color="yellow">}</rd-annotation></span><span><rd-annotation data-annotation-id-value="MVML5nU4ZZ52zJYEd4zXBZ" data-annotation-color="yellow">
</rd-annotation></span></span></span><span><span><span><rd-annotation data-annotation-id-value="MVML5nU4ZZ52zJYEd4zXBZ" data-annotation-color="yellow">    </rd-annotation></span><span><rd-annotation data-annotation-id-value="MVML5nU4ZZ52zJYEd4zXBZ" data-annotation-color="yellow">}</rd-annotation></span><span><rd-annotation data-annotation-id-value="MVML5nU4ZZ52zJYEd4zXBZ" data-annotation-color="yellow">
</rd-annotation></span></span></span><span><span><span><rd-annotation data-annotation-id-value="MVML5nU4ZZ52zJYEd4zXBZ" data-annotation-color="yellow">}</rd-annotation></span><span>
</span></span></span></code></pre></div><p><rd-annotation id="annotation-SNTKX1kNAbvmWH9B9zHwnX" data-annotation-id-value="SNTKX1kNAbvmWH9B9zHwnX" data-annotation-color="yellow">To generate a </rd-annotation><code><rd-annotation data-annotation-id-value="SNTKX1kNAbvmWH9B9zHwnX" data-annotation-color="yellow">BadType</rd-annotation></code><rd-annotation data-annotation-id-value="SNTKX1kNAbvmWH9B9zHwnX" data-annotation-color="yellow">:</rd-annotation></p><div><pre tabindex="0"><code><span><span><span><rd-annotation id="annotation-2tRAcBhxnBcAgc5fuzvbHq" data-annotation-id-value="2tRAcBhxnBcAgc5fuzvbHq" data-annotation-color="yellow">fn</rd-annotation></span><rd-annotation data-annotation-id-value="2tRAcBhxnBcAgc5fuzvbHq" data-annotation-color="yellow"> </rd-annotation><span><rd-annotation data-annotation-id-value="2tRAcBhxnBcAgc5fuzvbHq" data-annotation-color="yellow">generate_bad_type</rd-annotation></span><span><rd-annotation data-annotation-id-value="2tRAcBhxnBcAgc5fuzvbHq" data-annotation-color="yellow">()</rd-annotation></span><span><rd-annotation data-annotation-id-value="2tRAcBhxnBcAgc5fuzvbHq" data-annotation-color="yellow"> </rd-annotation></span><rd-annotation data-annotation-id-value="2tRAcBhxnBcAgc5fuzvbHq" data-annotation-color="yellow">-&gt; </rd-annotation><span><rd-annotation data-annotation-id-value="2tRAcBhxnBcAgc5fuzvbHq" data-annotation-color="yellow">BadType</rd-annotation></span><span><rd-annotation data-annotation-id-value="2tRAcBhxnBcAgc5fuzvbHq" data-annotation-color="yellow"> </rd-annotation></span><span><rd-annotation data-annotation-id-value="2tRAcBhxnBcAgc5fuzvbHq" data-annotation-color="yellow">{</rd-annotation></span><span><rd-annotation data-annotation-id-value="2tRAcBhxnBcAgc5fuzvbHq" data-annotation-color="yellow">
</rd-annotation></span></span></span><span><span><span><rd-annotation data-annotation-id-value="2tRAcBhxnBcAgc5fuzvbHq" data-annotation-color="yellow">    </rd-annotation></span><span><rd-annotation data-annotation-id-value="2tRAcBhxnBcAgc5fuzvbHq" data-annotation-color="yellow">// Generate a value between 0 and 10000;
</rd-annotation></span></span></span><span><span><span><rd-annotation data-annotation-id-value="2tRAcBhxnBcAgc5fuzvbHq" data-annotation-color="yellow">    </rd-annotation></span><span><rd-annotation data-annotation-id-value="2tRAcBhxnBcAgc5fuzvbHq" data-annotation-color="yellow">let</rd-annotation></span><span><rd-annotation data-annotation-id-value="2tRAcBhxnBcAgc5fuzvbHq" data-annotation-color="yellow"> </rd-annotation></span><span><rd-annotation data-annotation-id-value="2tRAcBhxnBcAgc5fuzvbHq" data-annotation-color="yellow">value</rd-annotation></span><span><rd-annotation data-annotation-id-value="2tRAcBhxnBcAgc5fuzvbHq" data-annotation-color="yellow"> </rd-annotation></span><span><rd-annotation data-annotation-id-value="2tRAcBhxnBcAgc5fuzvbHq" data-annotation-color="yellow">=</rd-annotation></span><span><rd-annotation data-annotation-id-value="2tRAcBhxnBcAgc5fuzvbHq" data-annotation-color="yellow"> </rd-annotation></span><span><rd-annotation data-annotation-id-value="2tRAcBhxnBcAgc5fuzvbHq" data-annotation-color="yellow">/* ... */</rd-annotation></span><span><rd-annotation data-annotation-id-value="2tRAcBhxnBcAgc5fuzvbHq" data-annotation-color="yellow">;</rd-annotation></span><span><rd-annotation data-annotation-id-value="2tRAcBhxnBcAgc5fuzvbHq" data-annotation-color="yellow">
</rd-annotation></span></span></span><span><span><span><rd-annotation data-annotation-id-value="2tRAcBhxnBcAgc5fuzvbHq" data-annotation-color="yellow">    </rd-annotation></span><span><rd-annotation data-annotation-id-value="2tRAcBhxnBcAgc5fuzvbHq" data-annotation-color="yellow">// Generate a list of behaviors of length 0..128, where the elements are
</rd-annotation></span></span></span><span><span><span><rd-annotation data-annotation-id-value="2tRAcBhxnBcAgc5fuzvbHq" data-annotation-color="yellow">    </rd-annotation></span><span><rd-annotation data-annotation-id-value="2tRAcBhxnBcAgc5fuzvbHq" data-annotation-color="yellow">// Regular 4/5 times and Flipped 1/5 times.
</rd-annotation></span></span></span><span><span><span><rd-annotation data-annotation-id-value="2tRAcBhxnBcAgc5fuzvbHq" data-annotation-color="yellow">    </rd-annotation></span><span><rd-annotation data-annotation-id-value="2tRAcBhxnBcAgc5fuzvbHq" data-annotation-color="yellow">let</rd-annotation></span><span><rd-annotation data-annotation-id-value="2tRAcBhxnBcAgc5fuzvbHq" data-annotation-color="yellow"> </rd-annotation></span><span><rd-annotation data-annotation-id-value="2tRAcBhxnBcAgc5fuzvbHq" data-annotation-color="yellow">ord_behavior</rd-annotation></span><rd-annotation data-annotation-id-value="2tRAcBhxnBcAgc5fuzvbHq" data-annotation-color="yellow">: </rd-annotation><span><rd-annotation data-annotation-id-value="2tRAcBhxnBcAgc5fuzvbHq" data-annotation-color="yellow">Vec</rd-annotation></span><span><rd-annotation data-annotation-id-value="2tRAcBhxnBcAgc5fuzvbHq" data-annotation-color="yellow">&lt;</rd-annotation></span><span><rd-annotation data-annotation-id-value="2tRAcBhxnBcAgc5fuzvbHq" data-annotation-color="yellow">OrdBehavior</rd-annotation></span><span><rd-annotation data-annotation-id-value="2tRAcBhxnBcAgc5fuzvbHq" data-annotation-color="yellow">&gt;</rd-annotation></span><span><rd-annotation data-annotation-id-value="2tRAcBhxnBcAgc5fuzvbHq" data-annotation-color="yellow"> </rd-annotation></span><span><rd-annotation data-annotation-id-value="2tRAcBhxnBcAgc5fuzvbHq" data-annotation-color="yellow">=</rd-annotation></span><span><rd-annotation data-annotation-id-value="2tRAcBhxnBcAgc5fuzvbHq" data-annotation-color="yellow"> </rd-annotation></span><span><rd-annotation data-annotation-id-value="2tRAcBhxnBcAgc5fuzvbHq" data-annotation-color="yellow">/* ... */</rd-annotation></span><span><rd-annotation data-annotation-id-value="2tRAcBhxnBcAgc5fuzvbHq" data-annotation-color="yellow">;</rd-annotation></span><span><rd-annotation data-annotation-id-value="2tRAcBhxnBcAgc5fuzvbHq" data-annotation-color="yellow">
</rd-annotation></span></span></span><span><span><span><rd-annotation data-annotation-id-value="2tRAcBhxnBcAgc5fuzvbHq" data-annotation-color="yellow">
</rd-annotation></span></span></span><span><span><span><rd-annotation data-annotation-id-value="2tRAcBhxnBcAgc5fuzvbHq" data-annotation-color="yellow">    </rd-annotation></span><span><rd-annotation data-annotation-id-value="2tRAcBhxnBcAgc5fuzvbHq" data-annotation-color="yellow">BadType</rd-annotation></span><span><rd-annotation data-annotation-id-value="2tRAcBhxnBcAgc5fuzvbHq" data-annotation-color="yellow"> </rd-annotation></span><span><rd-annotation data-annotation-id-value="2tRAcBhxnBcAgc5fuzvbHq" data-annotation-color="yellow">{</rd-annotation></span><span><rd-annotation data-annotation-id-value="2tRAcBhxnBcAgc5fuzvbHq" data-annotation-color="yellow">
</rd-annotation></span></span></span><span><span><span><rd-annotation data-annotation-id-value="2tRAcBhxnBcAgc5fuzvbHq" data-annotation-color="yellow">        </rd-annotation></span><span><rd-annotation data-annotation-id-value="2tRAcBhxnBcAgc5fuzvbHq" data-annotation-color="yellow">value</rd-annotation></span><span><rd-annotation data-annotation-id-value="2tRAcBhxnBcAgc5fuzvbHq" data-annotation-color="yellow">,</rd-annotation></span><span><rd-annotation data-annotation-id-value="2tRAcBhxnBcAgc5fuzvbHq" data-annotation-color="yellow">
</rd-annotation></span></span></span><span><span><span><rd-annotation data-annotation-id-value="2tRAcBhxnBcAgc5fuzvbHq" data-annotation-color="yellow">        </rd-annotation></span><span><rd-annotation data-annotation-id-value="2tRAcBhxnBcAgc5fuzvbHq" data-annotation-color="yellow">ord_behavior</rd-annotation></span><rd-annotation data-annotation-id-value="2tRAcBhxnBcAgc5fuzvbHq" data-annotation-color="yellow">: </rd-annotation><span><rd-annotation data-annotation-id-value="2tRAcBhxnBcAgc5fuzvbHq" data-annotation-color="yellow">RefCell</rd-annotation></span><rd-annotation data-annotation-id-value="2tRAcBhxnBcAgc5fuzvbHq" data-annotation-color="yellow">::</rd-annotation><span><rd-annotation data-annotation-id-value="2tRAcBhxnBcAgc5fuzvbHq" data-annotation-color="yellow">new</rd-annotation></span><span><rd-annotation data-annotation-id-value="2tRAcBhxnBcAgc5fuzvbHq" data-annotation-color="yellow">(</rd-annotation></span><span><rd-annotation data-annotation-id-value="2tRAcBhxnBcAgc5fuzvbHq" data-annotation-color="yellow">ord_behavior</rd-annotation></span><span><rd-annotation data-annotation-id-value="2tRAcBhxnBcAgc5fuzvbHq" data-annotation-color="yellow">),</rd-annotation></span><span><rd-annotation data-annotation-id-value="2tRAcBhxnBcAgc5fuzvbHq" data-annotation-color="yellow">
</rd-annotation></span></span></span><span><span><span><rd-annotation data-annotation-id-value="2tRAcBhxnBcAgc5fuzvbHq" data-annotation-color="yellow">    </rd-annotation></span><span><rd-annotation data-annotation-id-value="2tRAcBhxnBcAgc5fuzvbHq" data-annotation-color="yellow">}</rd-annotation></span><span><rd-annotation data-annotation-id-value="2tRAcBhxnBcAgc5fuzvbHq" data-annotation-color="yellow">
</rd-annotation></span></span></span><span><span><span><rd-annotation data-annotation-id-value="2tRAcBhxnBcAgc5fuzvbHq" data-annotation-color="yellow">}</rd-annotation></span><span>
</span></span></span></code></pre></div><p>And to test this:</p><div><pre tabindex="0"><code><span><span><span>#[test]</span><span>
</span></span></span><span><span><span>fn</span> <span>test_my_sort_3</span><span>()</span><span> </span><span>{</span><span>
</span></span></span><span><span><span>    </span><span>// Run the test 1024 times.
</span></span></span><span><span><span>    </span><span>for</span><span> </span><span>_</span><span> </span><span>in</span><span> </span><span>0</span><span>..</span><span>1024</span><span> </span><span>{</span><span>
</span></span></span><span><span><span>        </span><span>// Generate a list of BadTypes using generate_bad_type.
</span></span></span><span><span><span>        </span><span>let</span><span> </span><span>input</span>: <span>Vec</span><span>&lt;</span><span>BadType</span><span>&gt;</span><span> </span><span>=</span><span> </span><span>/* ... */</span><span>;</span><span>
</span></span></span><span><span><span>
</span></span></span><span><span><span>        </span><span>// Call sort as before.
</span></span></span><span><span><span>        </span><span>let</span><span> </span><span>mut</span><span> </span><span>output</span><span> </span><span>=</span><span> </span><span>input</span><span>.</span><span>clone</span><span>();</span><span>
</span></span></span><span><span><span>        </span><span>my_sort</span><span>(</span><span>&amp;</span><span>mut</span><span> </span><span>output</span><span>);</span><span>
</span></span></span><span><span><span>
</span></span></span><span><span><span>        </span><span>// Sorting isn&#39;t really well-defined in this case, but we can
</span></span></span><span><span><span>        </span><span>// ensure two properties:
</span></span></span><span><span><span>        </span><span>//
</span></span></span><span><span><span>        </span><span>// 1. my_sort doesn&#39;t panic (implicitly checked by getting here)
</span></span></span><span><span><span>        </span><span>// 2. all the input values are still present in the output
</span></span></span><span><span><span>        </span><span>let</span><span> </span><span>mut</span><span> </span><span>input_values</span>: <span>Vec</span><span>&lt;</span><span>u64</span><span>&gt;</span><span> </span><span>=</span><span>
</span></span></span><span><span><span>            </span><span>input</span><span>.</span><span>iter</span><span>().</span><span>map</span><span>(</span><span>|</span><span>v</span><span>|</span><span> </span><span>v</span><span>.</span><span>value</span><span>).</span><span>collect</span><span>();</span><span>
</span></span></span><span><span><span>        </span><span>let</span><span> </span><span>mut</span><span> </span><span>output_values</span>: <span>Vec</span><span>&lt;</span><span>u64</span><span>&gt;</span><span> </span><span>=</span><span>
</span></span></span><span><span><span>            </span><span>output</span><span>.</span><span>iter</span><span>().</span><span>map</span><span>(</span><span>|</span><span>v</span><span>|</span><span> </span><span>v</span><span>.</span><span>value</span><span>).</span><span>collect</span><span>();</span><span>
</span></span></span><span><span><span>
</span></span></span><span><span><span>        </span><span>// Sort the input and output values, and assert that they match.
</span></span></span><span><span><span>        </span><span>my_sort</span><span>(</span><span>&amp;</span><span>mut</span><span> </span><span>input_values</span><span>);</span><span>
</span></span></span><span><span><span>        </span><span>my_sort</span><span>(</span><span>&amp;</span><span>mut</span><span> </span><span>output_values</span><span>);</span><span>
</span></span></span><span><span><span>        </span><span>assert_eq!</span><span>(</span><span>input_values</span><span>,</span><span> </span><span>output_values</span><span>);</span><span>
</span></span></span><span><span><span>    </span><span>}</span><span>
</span></span></span><span><span><span>}</span><span>
</span></span></span></code></pre></div><p><rd-annotation id="annotation-ApSsjQe5Tc4sxLpT3SdkmU" data-annotation-id-value="ApSsjQe5Tc4sxLpT3SdkmU" data-annotation-color="yellow">Our original approach continues to work well—that is, right until the test finds a bug and we need to shrink a failing input.</rd-annotation></p><h2 id="hL.WCag.3-integrated-shrinking"><rd-annotation id="annotation-HVjknRmVPB8PovqQMoKQHH" data-annotation-id-value="HVjknRmVPB8PovqQMoKQHH" data-annotation-color="yellow">3. Integrated shrinking</rd-annotation><a href="#hL.WCag.3-integrated-shrinking" arialabel="Anchor" rel="nofollow noopener noreferrer">#</a></h2><p>How does one go about writing a shrinker for <code>Vec&lt;BadType&gt;</code>? Doing so seemed relatively straightforward for a list of integers. But this is a list where the elements are pairs of an integer <em>and another list</em>. Also:</p><ul><li><p>We’ve just tested Ord safety so far—once we’ve added fault injection for other kinds of safety, the complexity seems endless.</p></li><li><p>And even more importantly, there isn’t a great way to compose smaller shrinkers together to form larger ones. Writing shrinkers is a lot of work already, and what’s the point if you have to keep doing all of it over and over?</p></li></ul><p><rd-annotation id="annotation-KzTqMt5ESbHFUPRobbQTFm" data-annotation-id-value="KzTqMt5ESbHFUPRobbQTFm" data-annotation-color="yellow">The practical result is that most of the time, writing a shrinker for types like </rd-annotation><code><rd-annotation data-annotation-id-value="KzTqMt5ESbHFUPRobbQTFm" data-annotation-color="yellow">Vec&lt;BadType&gt;</rd-annotation></code><rd-annotation data-annotation-id-value="KzTqMt5ESbHFUPRobbQTFm" data-annotation-color="yellow"> is quite difficult. And writing one is also technically optional, since:</rd-annotation></p><ul><li><rd-annotation data-annotation-id-value="KzTqMt5ESbHFUPRobbQTFm" data-annotation-color="yellow">If the test passes, shrinkers are never invoked. Simply write correct code, and shrinking just isn’t an issue!</rd-annotation></li><li><rd-annotation data-annotation-id-value="KzTqMt5ESbHFUPRobbQTFm" data-annotation-color="yellow">If the test fails, developers can debug using the original input. It’s painful but possible.</rd-annotation></li></ul><p>All in all, given the choice of writing a shrinker by hand or just moving on with their lives, most developers tend to choose the latter<sup id="hL.WCag.fnref:2"><a href="#hL.WCag.fn:2" role="doc-noteref" rel="nofollow noopener noreferrer">2</a></sup>. Because of this, <rd-annotation id="annotation-BJ9wBS2b1AmGtEzDnJfvwf" data-annotation-id-value="BJ9wBS2b1AmGtEzDnJfvwf" data-annotation-color="yellow">most modern property-based testing frameworks, like </rd-annotation><a href="https://docs.rs/proptest" rel="nofollow noopener noreferrer"><strong><rd-annotation data-annotation-id-value="BJ9wBS2b1AmGtEzDnJfvwf" data-annotation-color="yellow">proptest</rd-annotation></strong></a><rd-annotation data-annotation-id-value="BJ9wBS2b1AmGtEzDnJfvwf" data-annotation-color="yellow"> in Rust, try and take care of shrinking for you through some notion of </rd-annotation><em><rd-annotation data-annotation-id-value="BJ9wBS2b1AmGtEzDnJfvwf" data-annotation-color="yellow">integrated shrinking</rd-annotation></em><rd-annotation data-annotation-id-value="BJ9wBS2b1AmGtEzDnJfvwf" data-annotation-color="yellow">.</rd-annotation></p><p><rd-annotation id="annotation-H158vNvcJ6VojYa3eNhia1" data-annotation-id-value="H158vNvcJ6VojYa3eNhia1" data-annotation-color="green">The idea behind integrated shrinking is: When you generate a random input, you don’t just generate the value itself. You also generate some context that is helpful for reducing the size of the input.</rd-annotation></p><ul><li><rd-annotation id="annotation-WXYkpGX4yD4K56VRo1Vxgf" data-annotation-id-value="WXYkpGX4yD4K56VRo1Vxgf" data-annotation-color="yellow">In proptest, this combined value and context is called a </rd-annotation><a href="https://docs.rs/proptest/latest/proptest/strategy/trait.ValueTree.html" rel="nofollow noopener noreferrer"><strong><rd-annotation data-annotation-id-value="WXYkpGX4yD4K56VRo1Vxgf" data-annotation-color="yellow">value tree</rd-annotation></strong></a><rd-annotation data-annotation-id-value="WXYkpGX4yD4K56VRo1Vxgf" data-annotation-color="yellow">.</rd-annotation></li><li><rd-annotation data-annotation-id-value="WXYkpGX4yD4K56VRo1Vxgf" data-annotation-color="yellow">Any implementation that accepts a random number generator and turns it into a value tree is called a </rd-annotation><a href="https://docs.rs/proptest/latest/proptest/strategy/trait.Strategy.html" rel="nofollow noopener noreferrer"><strong><rd-annotation data-annotation-id-value="WXYkpGX4yD4K56VRo1Vxgf" data-annotation-color="yellow">strategy</rd-annotation></strong></a><rd-annotation data-annotation-id-value="WXYkpGX4yD4K56VRo1Vxgf" data-annotation-color="yellow">.</rd-annotation></li></ul><p>The proptest library comes with many different kinds of strategies that can be composed together to create more complex ones. To generate an instance of <code>OrdBehavior</code>, we’re going to use two strategies:</p><ul><li>The <a href="https://docs.rs/proptest/latest/proptest/strategy/struct.Just.html" rel="nofollow noopener noreferrer"><strong><code>Just</code> strategy</strong></a>, which “just” returns a single value.</li><li><rd-annotation id="annotation-XfcJmUWz9TzByrTinwuBdB" data-annotation-id-value="XfcJmUWz9TzByrTinwuBdB" data-annotation-color="yellow">The </rd-annotation><a href="https://docs.rs/proptest/latest/proptest/macro.prop_oneof.html" rel="nofollow noopener noreferrer"><strong><code><rd-annotation data-annotation-id-value="XfcJmUWz9TzByrTinwuBdB" data-annotation-color="yellow">prop_oneof</rd-annotation></code><rd-annotation data-annotation-id-value="XfcJmUWz9TzByrTinwuBdB" data-annotation-color="yellow"> strategy</rd-annotation></strong></a><rd-annotation data-annotation-id-value="XfcJmUWz9TzByrTinwuBdB" data-annotation-color="yellow">, which generates values from one of a possible list of strategies, where each choice has a given probability. (A function that takes one or more strategies as input, and produces a strategy as its output, is called a </rd-annotation><strong><rd-annotation data-annotation-id-value="XfcJmUWz9TzByrTinwuBdB" data-annotation-color="yellow">combinator</rd-annotation></strong><rd-annotation data-annotation-id-value="XfcJmUWz9TzByrTinwuBdB" data-annotation-color="yellow">.)</rd-annotation></li></ul><div><pre tabindex="0"><code><span><span><span><rd-annotation id="annotation-88TNSYFxzmZwFquMUoWshh" data-annotation-id-value="88TNSYFxzmZwFquMUoWshh" data-annotation-color="yellow">fn</rd-annotation></span><rd-annotation data-annotation-id-value="88TNSYFxzmZwFquMUoWshh" data-annotation-color="yellow"> </rd-annotation><span><rd-annotation data-annotation-id-value="88TNSYFxzmZwFquMUoWshh" data-annotation-color="yellow">generate_ord_behavior</rd-annotation></span><span><rd-annotation data-annotation-id-value="88TNSYFxzmZwFquMUoWshh" data-annotation-color="yellow">()</rd-annotation></span><span><rd-annotation data-annotation-id-value="88TNSYFxzmZwFquMUoWshh" data-annotation-color="yellow"> </rd-annotation></span><rd-annotation data-annotation-id-value="88TNSYFxzmZwFquMUoWshh" data-annotation-color="yellow">-&gt; </rd-annotation><span><rd-annotation data-annotation-id-value="88TNSYFxzmZwFquMUoWshh" data-annotation-color="yellow">impl</rd-annotation></span><span><rd-annotation data-annotation-id-value="88TNSYFxzmZwFquMUoWshh" data-annotation-color="yellow"> </rd-annotation></span><span><rd-annotation data-annotation-id-value="88TNSYFxzmZwFquMUoWshh" data-annotation-color="yellow">Strategy</rd-annotation></span><span><rd-annotation data-annotation-id-value="88TNSYFxzmZwFquMUoWshh" data-annotation-color="yellow">&lt;</rd-annotation></span><span><rd-annotation data-annotation-id-value="88TNSYFxzmZwFquMUoWshh" data-annotation-color="yellow">Value</rd-annotation></span><span><rd-annotation data-annotation-id-value="88TNSYFxzmZwFquMUoWshh" data-annotation-color="yellow"> </rd-annotation></span><span><rd-annotation data-annotation-id-value="88TNSYFxzmZwFquMUoWshh" data-annotation-color="yellow">=</rd-annotation></span><span><rd-annotation data-annotation-id-value="88TNSYFxzmZwFquMUoWshh" data-annotation-color="yellow"> </rd-annotation></span><span><rd-annotation data-annotation-id-value="88TNSYFxzmZwFquMUoWshh" data-annotation-color="yellow">OrdBehavior</rd-annotation></span><span><rd-annotation data-annotation-id-value="88TNSYFxzmZwFquMUoWshh" data-annotation-color="yellow">&gt;</rd-annotation></span><span><rd-annotation data-annotation-id-value="88TNSYFxzmZwFquMUoWshh" data-annotation-color="yellow"> </rd-annotation></span><span><rd-annotation data-annotation-id-value="88TNSYFxzmZwFquMUoWshh" data-annotation-color="yellow">{</rd-annotation></span><span><rd-annotation data-annotation-id-value="88TNSYFxzmZwFquMUoWshh" data-annotation-color="yellow">
</rd-annotation></span></span></span><span><span><span><rd-annotation data-annotation-id-value="88TNSYFxzmZwFquMUoWshh" data-annotation-color="yellow">    </rd-annotation></span><span><rd-annotation data-annotation-id-value="88TNSYFxzmZwFquMUoWshh" data-annotation-color="yellow">prop_oneof!</rd-annotation></span><span><rd-annotation data-annotation-id-value="88TNSYFxzmZwFquMUoWshh" data-annotation-color="yellow">[</rd-annotation></span><span><rd-annotation data-annotation-id-value="88TNSYFxzmZwFquMUoWshh" data-annotation-color="yellow">
</rd-annotation></span></span></span><span><span><span><rd-annotation data-annotation-id-value="88TNSYFxzmZwFquMUoWshh" data-annotation-color="yellow">        </rd-annotation></span><span><rd-annotation data-annotation-id-value="88TNSYFxzmZwFquMUoWshh" data-annotation-color="yellow">// 4/5 chance that the Regular implementation is generated.
</rd-annotation></span></span></span><span><span><span><rd-annotation data-annotation-id-value="88TNSYFxzmZwFquMUoWshh" data-annotation-color="yellow">        </rd-annotation></span><span><rd-annotation data-annotation-id-value="88TNSYFxzmZwFquMUoWshh" data-annotation-color="yellow">4</rd-annotation></span><span><rd-annotation data-annotation-id-value="88TNSYFxzmZwFquMUoWshh" data-annotation-color="yellow"> </rd-annotation></span><span><rd-annotation data-annotation-id-value="88TNSYFxzmZwFquMUoWshh" data-annotation-color="yellow">=&gt;</rd-annotation></span><span><rd-annotation data-annotation-id-value="88TNSYFxzmZwFquMUoWshh" data-annotation-color="yellow"> </rd-annotation></span><span><rd-annotation data-annotation-id-value="88TNSYFxzmZwFquMUoWshh" data-annotation-color="yellow">Just</rd-annotation></span><span><rd-annotation data-annotation-id-value="88TNSYFxzmZwFquMUoWshh" data-annotation-color="yellow">(</rd-annotation></span><span><rd-annotation data-annotation-id-value="88TNSYFxzmZwFquMUoWshh" data-annotation-color="yellow">OrdBehavior</rd-annotation></span><rd-annotation data-annotation-id-value="88TNSYFxzmZwFquMUoWshh" data-annotation-color="yellow">::</rd-annotation><span><rd-annotation data-annotation-id-value="88TNSYFxzmZwFquMUoWshh" data-annotation-color="yellow">Regular</rd-annotation></span><span><rd-annotation data-annotation-id-value="88TNSYFxzmZwFquMUoWshh" data-annotation-color="yellow">),</rd-annotation></span><span><rd-annotation data-annotation-id-value="88TNSYFxzmZwFquMUoWshh" data-annotation-color="yellow">
</rd-annotation></span></span></span><span><span><span><rd-annotation data-annotation-id-value="88TNSYFxzmZwFquMUoWshh" data-annotation-color="yellow">        </rd-annotation></span><span><rd-annotation data-annotation-id-value="88TNSYFxzmZwFquMUoWshh" data-annotation-color="yellow">// 1/5 chance that it&#39;s flipped.
</rd-annotation></span></span></span><span><span><span><rd-annotation data-annotation-id-value="88TNSYFxzmZwFquMUoWshh" data-annotation-color="yellow">        </rd-annotation></span><span><rd-annotation data-annotation-id-value="88TNSYFxzmZwFquMUoWshh" data-annotation-color="yellow">1</rd-annotation></span><span><rd-annotation data-annotation-id-value="88TNSYFxzmZwFquMUoWshh" data-annotation-color="yellow"> </rd-annotation></span><span><rd-annotation data-annotation-id-value="88TNSYFxzmZwFquMUoWshh" data-annotation-color="yellow">=&gt;</rd-annotation></span><span><rd-annotation data-annotation-id-value="88TNSYFxzmZwFquMUoWshh" data-annotation-color="yellow"> </rd-annotation></span><span><rd-annotation data-annotation-id-value="88TNSYFxzmZwFquMUoWshh" data-annotation-color="yellow">Just</rd-annotation></span><span><rd-annotation data-annotation-id-value="88TNSYFxzmZwFquMUoWshh" data-annotation-color="yellow">(</rd-annotation></span><span><rd-annotation data-annotation-id-value="88TNSYFxzmZwFquMUoWshh" data-annotation-color="yellow">OrdBehavior</rd-annotation></span><rd-annotation data-annotation-id-value="88TNSYFxzmZwFquMUoWshh" data-annotation-color="yellow">::</rd-annotation><span><rd-annotation data-annotation-id-value="88TNSYFxzmZwFquMUoWshh" data-annotation-color="yellow">Flipped</rd-annotation></span><span><rd-annotation data-annotation-id-value="88TNSYFxzmZwFquMUoWshh" data-annotation-color="yellow">),</rd-annotation></span><span><rd-annotation data-annotation-id-value="88TNSYFxzmZwFquMUoWshh" data-annotation-color="yellow">
</rd-annotation></span></span></span><span><span><span><rd-annotation data-annotation-id-value="88TNSYFxzmZwFquMUoWshh" data-annotation-color="yellow">    </rd-annotation></span><span><rd-annotation data-annotation-id-value="88TNSYFxzmZwFquMUoWshh" data-annotation-color="yellow">]</rd-annotation></span><span><rd-annotation data-annotation-id-value="88TNSYFxzmZwFquMUoWshh" data-annotation-color="yellow">
</rd-annotation></span></span></span><span><span><span><rd-annotation data-annotation-id-value="88TNSYFxzmZwFquMUoWshh" data-annotation-color="yellow">}</rd-annotation></span><span>
</span></span></span></code></pre></div><p>To generate <code>BadType</code>, we’re going to use <code>generate_ord_behavior</code>, as well as:</p><ul><li>A <a href="https://docs.rs/proptest/latest/proptest/strategy/trait.Strategy.html%23impl-Strategy-for-Range%3Cu64%3E" rel="nofollow noopener noreferrer"><strong>range strategy</strong></a> such as <code>0..10000_u64</code>, which generates values within the range uniformly at random.</li><li>The <a href="https://docs.rs/proptest/latest/proptest/collection/fn.vec.html" rel="nofollow noopener noreferrer"><strong><code>vec</code> combinator</strong></a>, which accepts a strategy for elements and a size parameter.</li></ul><div><pre tabindex="0"><code><span><span><span>fn</span> <span>generate_bad_type</span><span>()</span><span> </span>-&gt; <span>impl</span><span> </span><span>Strategy</span><span>&lt;</span><span>Value</span><span> </span><span>=</span><span> </span><span>BadType</span><span>&gt;</span><span> </span><span>{</span><span>
</span></span></span><span><span><span>    </span><span>// Use the range strategy to generate values uniformly at random.
</span></span></span><span><span><span>    </span><span>let</span><span> </span><span>value_strategy</span><span> </span><span>=</span><span> </span><span>0</span><span>..</span><span>10000_</span><span>u64</span><span>;</span><span>
</span></span></span><span><span><span>
</span></span></span><span><span><span>    </span><span>// Use the vec strategy to generate a list of behaviors: 0..128 items.
</span></span></span><span><span><span>    </span><span>let</span><span> </span><span>ord_behavior_strategy</span><span> </span><span>=</span><span> </span><span>vec</span><span>(</span><span>generate_ord_behavior</span><span>(),</span><span> </span><span>0</span><span>..</span><span>128</span><span>);</span><span>
</span></span></span><span><span><span>
</span></span></span><span><span><span>    </span><span>// Now what? We need to compose these strategies together. With proptest,
</span></span></span><span><span><span>    </span><span>// the way to do this is to first create a tuple of strategies.
</span></span></span><span><span><span>    </span><span>let</span><span> </span><span>tuple_strategy</span><span> </span><span>=</span><span> </span><span>(</span><span>value_strategy</span><span>,</span><span> </span><span>ord_behavior_strategy</span><span>);</span><span>
</span></span></span><span><span><span>
</span></span></span><span><span><span>    </span><span>// A tuple of strategies is also a strategy! Generated values are a tuple
</span></span></span><span><span><span>    </span><span>// of constituents.
</span></span></span><span><span><span>    </span><span>//
</span></span></span><span><span><span>    </span><span>// With this in hand, we can use a function called `prop_map` to turn the
</span></span></span><span><span><span>    </span><span>// tuple into a BadType.
</span></span></span><span><span><span>    </span><span>tuple_strategy</span><span>.</span><span>prop_map</span><span>(</span><span>|</span><span>(</span><span>value</span><span>,</span><span> </span><span>ord_behavior</span><span>)</span><span>|</span><span> </span><span>{</span><span>
</span></span></span><span><span><span>        </span><span>BadType</span><span> </span><span>{</span><span>
</span></span></span><span><span><span>            </span><span>value</span><span>,</span><span>
</span></span></span><span><span><span>            </span><span>ord_behavior</span>: <span>RefCell</span>::<span>new</span><span>(</span><span>ord_behavior</span><span>),</span><span>
</span></span></span><span><span><span>        </span><span>}</span><span>
</span></span></span><span><span><span>    </span><span>})</span><span>
</span></span></span><span><span><span>}</span><span>
</span></span></span></code></pre></div><figure id=""><img src="https://readeck.qauz.de/bm/Ls/Ls4P3Q3TgG1ppLpzbAKtfo/_resources/Xy2GFRiEzXKgoTwrSdvbDU.png" alt="A flowchart to show how smaller strategies flow into larger ones. See code comments in sample above for a full explanation." id="" width="1280" height="1809" loading="lazy"/><figcaption id="">Composing smaller strategies into a larger one for <code id="">BadType</code>.</figcaption></figure><p><rd-annotation id="annotation-W2SNBkZmdZVH1Xs11hceEe" data-annotation-id-value="W2SNBkZmdZVH1Xs11hceEe" data-annotation-color="yellow">You might be wondering where all the shrinking code is. It’s actually implemented on the corresponding value trees for each strategy:</rd-annotation></p><ul><li><rd-annotation data-annotation-id-value="W2SNBkZmdZVH1Xs11hceEe" data-annotation-color="yellow">Range strategies use binary search to make values smaller.</rd-annotation></li><li><rd-annotation data-annotation-id-value="W2SNBkZmdZVH1Xs11hceEe" data-annotation-color="yellow">The </rd-annotation><code><rd-annotation data-annotation-id-value="W2SNBkZmdZVH1Xs11hceEe" data-annotation-color="yellow">Just</rd-annotation></code><rd-annotation data-annotation-id-value="W2SNBkZmdZVH1Xs11hceEe" data-annotation-color="yellow"> strategy doesn’t do any shrinking, since it just returns a single value.</rd-annotation></li><li><rd-annotation data-annotation-id-value="W2SNBkZmdZVH1Xs11hceEe" data-annotation-color="yellow">The </rd-annotation><code><rd-annotation data-annotation-id-value="W2SNBkZmdZVH1Xs11hceEe" data-annotation-color="yellow">prop_oneof</rd-annotation></code><rd-annotation data-annotation-id-value="W2SNBkZmdZVH1Xs11hceEe" data-annotation-color="yellow"> combinator shrinks towards the beginning of the choices: in this case, </rd-annotation><code><rd-annotation data-annotation-id-value="W2SNBkZmdZVH1Xs11hceEe" data-annotation-color="yellow">Flipped</rd-annotation></code><rd-annotation data-annotation-id-value="W2SNBkZmdZVH1Xs11hceEe" data-annotation-color="yellow"> is shrunk into </rd-annotation><code><rd-annotation data-annotation-id-value="W2SNBkZmdZVH1Xs11hceEe" data-annotation-color="yellow">Regular</rd-annotation></code><rd-annotation data-annotation-id-value="W2SNBkZmdZVH1Xs11hceEe" data-annotation-color="yellow">.</rd-annotation></li><li><rd-annotation data-annotation-id-value="W2SNBkZmdZVH1Xs11hceEe" data-annotation-color="yellow">The </rd-annotation><code><rd-annotation data-annotation-id-value="W2SNBkZmdZVH1Xs11hceEe" data-annotation-color="yellow">vec</rd-annotation></code><rd-annotation data-annotation-id-value="W2SNBkZmdZVH1Xs11hceEe" data-annotation-color="yellow"> combinator implements roughly the algorithm in </rd-annotation><a href="https://sunshowers.io/posts/monads-through-pbt/%23implementing-a-manual-shrinker" rel="nofollow noopener noreferrer"><em><rd-annotation data-annotation-id-value="W2SNBkZmdZVH1Xs11hceEe" data-annotation-color="yellow">Implementing a manual shrinker</rd-annotation></em></a><rd-annotation data-annotation-id-value="W2SNBkZmdZVH1Xs11hceEe" data-annotation-color="yellow"> above.</rd-annotation></li></ul><p>You can see how the base strategies get turned into successively larger ones through combinators like <code>prop_oneof</code>. It’s very similar to <a href="https://doc.rust-lang.org/std/iter/trait.Iterator.html" rel="nofollow noopener noreferrer"><code>Iterator</code></a>, where you can keep calling <code>.map</code>, <code>.filter</code>, <code>.enumerate</code> and so on over and over<sup id="hL.WCag.fnref:3"><a href="#hL.WCag.fn:3" role="doc-noteref" rel="nofollow noopener noreferrer">3</a></sup>.</p><p><rd-annotation id="annotation-ECadLNqdYMZsAAaFqDtfym" data-annotation-id-value="ECadLNqdYMZsAAaFqDtfym" data-annotation-color="yellow">In my experience, composability across different scales is where this model shines. You can build bigger strategies out of smaller ones, up to a surprising amount of complexity. This means that your team can invest in a library of ever-more-complex strategies, and continue to derive value out of that library across everything from the smallest of unit tests to large integration tests.</rd-annotation></p><p><rd-annotation id="annotation-LYFFnhd8qtk2YmLkLHjXv3" data-annotation-id-value="LYFFnhd8qtk2YmLkLHjXv3" data-annotation-color="green">But there is one </rd-annotation><em><rd-annotation data-annotation-id-value="LYFFnhd8qtk2YmLkLHjXv3" data-annotation-color="green">massive</rd-annotation></em><rd-annotation data-annotation-id-value="LYFFnhd8qtk2YmLkLHjXv3" data-annotation-color="green"> wrinkle with integrated shrinking. And that wrinkle is </rd-annotation><em><rd-annotation data-annotation-id-value="LYFFnhd8qtk2YmLkLHjXv3" data-annotation-color="green">exactly</rd-annotation></em><rd-annotation data-annotation-id-value="LYFFnhd8qtk2YmLkLHjXv3" data-annotation-color="green"> what monads are about.</rd-annotation></p><h2 id="hL.WCag.4-monads-finally"><rd-annotation id="annotation-GrTY4hq1UNuYcqyYA1pzzP" data-annotation-id-value="GrTY4hq1UNuYcqyYA1pzzP" data-annotation-color="yellow">4. Monads, finally</rd-annotation><a href="#hL.WCag.4-monads-finally" arialabel="Anchor" rel="nofollow noopener noreferrer">#</a></h2><p>In the previous few sections, we’ve built up all the context we need. We’re now going to look at the fundamental operation that introduces monadic composition to proptest: <a href="https://docs.rs/proptest/latest/proptest/strategy/trait.Strategy.html%23method.prop_flat_map" rel="nofollow noopener noreferrer"><code>prop_flat_map</code></a>.</p><figure id=""><img src="https://readeck.qauz.de/bm/Ls/Ls4P3Q3TgG1ppLpzbAKtfo/_resources/KvSAEy1vSW4PLtdSVZTjas.png" alt="Diagram comparing prop_map behavior before and after shrinking. Left panel labeled &#39;original&#39; shows value=100 passing through prop_map(x²) to produce value=10000. Right panel labeled &#39;shrink&#39; shows value=50 passing through the same prop_map(x²) function to produce value=2500. An arrow connects the two panels, illustrating how prop_map preserves the same transformation during shrinking, just with smaller values." id="" width="1280" height="816" loading="lazy"/><figcaption id=""><code id="">prop_map</code> from <em id="">x</em> to <em id="">x²</em>. When values are shrunk, they transparently pass through the map function.</figcaption></figure><p>In the example above, there’s a function called <a href="https://docs.rs/proptest/latest/proptest/strategy/trait.Strategy.html%23method.prop_map" rel="nofollow noopener noreferrer"><code>prop_map</code></a>, which we use to turn a tuple of components into a <code>BadType</code> value. What happens when you try and shrink a value through a <code>prop_map</code>? It’s very simple:</p><ul><li>Attempt to get a smaller value from the underlying value tree.</li><li>Call the map function on the value.</li></ul><p>So <code>prop_map</code> is just a conduit that values pass through: it simply maps a value to another value, and does not change the structure of the value tree in any way.</p><p>Now let’s say we want to test out pairs of <code>BadType</code> instances, where the way the second <code>BadType</code> is generated depends on the first. This is a situation where we don’t just want to map a value to another value—we need to generate a whole new <em>strategy</em> based on a value.</p><p>This is a <strong>fundamental shift</strong>:</p><ul><li>As above, <code>prop_map</code> transforms a value into another, but preserves the original structure.</li><li>This new method, <code>prop_flat_map</code>, goes well beyond that. Based on the value generated, it creates a brand new <em>strategy</em> with a structure all of its own.</li></ul><p>This is monadic composition in action. The result of one operation controls, at runtime, the entire shape of the next operation.</p><p>For example, here’s one way to go about generating pairs of <code>BadType</code>s, where the second value is always greater than the first:</p><div><pre tabindex="0"><code><span><span><span>fn</span> <span>generate_bad_type_pair</span><span>()</span><span> </span>-&gt; <span>impl</span><span> </span><span>Strategy</span><span>&lt;</span><span>Value</span><span> </span><span>=</span><span> </span><span>(</span><span>BadType</span><span>,</span><span> </span><span>BadType</span><span>)</span><span>&gt;</span><span> </span><span>{</span><span>
</span></span></span><span><span><span>    </span><span>// First generate a BadType.
</span></span></span><span><span><span>    </span><span>generate_bad_type</span><span>().</span><span>prop_flat_map</span><span>(</span><span>
</span></span></span><span><span><span>        </span><span>|</span><span>first_bad_type</span><span>|</span><span> </span><span>{</span><span>
</span></span></span><span><span><span>            </span><span>// Now generate a second BadType with a value greater than the first.
</span></span></span><span><span><span>            </span><span>(</span><span>
</span></span></span><span><span><span>                </span><span>(</span><span>first_bad_type</span><span>.</span><span>value</span><span> </span><span>+</span><span> </span><span>1</span><span>)</span><span>..</span><span>20000_</span><span>u64</span><span>,</span><span>
</span></span></span><span><span><span>                </span><span>vec</span><span>(</span><span>generate_ord_behavior</span><span>(),</span><span> </span><span>0</span><span>..</span><span>128</span><span>),</span><span>
</span></span></span><span><span><span>            </span><span>)</span><span>
</span></span></span><span><span><span>            </span><span>.</span><span>prop_map</span><span>(</span><span>move</span><span> </span><span>|</span><span>(</span><span>second_value</span><span>,</span><span> </span><span>ord_behavior</span><span>)</span><span>|</span><span> </span><span>{</span><span>
</span></span></span><span><span><span>                </span><span>// Generate the second value.
</span></span></span><span><span><span>                </span><span>let</span><span> </span><span>second_bad_type</span><span> </span><span>=</span><span> </span><span>BadType</span><span> </span><span>{</span><span>
</span></span></span><span><span><span>                    </span><span>value</span>: <span>second_value</span><span>,</span><span>
</span></span></span><span><span><span>                    </span><span>ord_behavior</span>: <span>RefCell</span>::<span>new</span><span>(</span><span>ord_behavior</span><span>),</span><span>
</span></span></span><span><span><span>                </span><span>};</span><span>
</span></span></span><span><span><span>
</span></span></span><span><span><span>                </span><span>// Return the pair.
</span></span></span><span><span><span>                </span><span>(</span><span>first_bad_type</span><span>.</span><span>clone</span><span>(),</span><span> </span><span>second_bad_type</span><span>)</span><span>
</span></span></span><span><span><span>            </span><span>})</span><span>
</span></span></span><span><span><span>        </span><span>}</span><span>
</span></span></span><span><span><span>    </span><span>)</span><span>
</span></span></span><span><span><span>}</span><span>
</span></span></span></code></pre></div><p>Your first reaction might be: <em>wow, this seems really powerful</em>. And you would be right! You can write <em>whatever you like</em> in the body of a <code>prop_flat_map</code>:</p><ul><li>You can conditionally return one strategy or another, reimplementing <a href="https://docs.rs/proptest/latest/proptest/macro.prop_oneof.html" rel="nofollow noopener noreferrer"><code>prop_oneof</code></a>.</li><li>You can first generate a size and then return a vector with those many elements, reimplementing the <code>vec</code> combinator.</li><li>You can call <code>prop_flat_map</code> again, as many times as you like.</li></ul><p>In a real and quite rigorous sense, <code>prop_flat_map</code> is maximally powerful. Every combinator we’ve talked about, and in fact most of the proptest library, can be written in terms of <code>prop_flat_map</code>.</p><p>So why do all these combinators exist? Why don’t we just use <code>prop_flat_map</code> everywhere?</p><p>The function actually works reasonably well in practice. It generates random values with the right shape, and shrinks them correctly on a failing input.</p><p><em>But.</em></p><p>Shrinking is <em>really, really slow.</em></p><p><em>Exponentially</em> slow.</p><figure id=""><img src="https://readeck.qauz.de/bm/Ls/Ls4P3Q3TgG1ppLpzbAKtfo/_resources/Xb7iUvUuo2DfzaivihBMMM.png" alt="Diagram comparing prop_flat_map behavior before and after shrinking. Left panel labeled &#39;original&#39; shows value=100 passing through prop_flat_map(0..x²) to create strategy:0..10000, which produces value=8634. Right panel labeled &#39;shrink&#39; shows value=50 passing through the same function to create a completely new strategy:0..2500 (highlighted in pink), which generates multiple different outputs (value=389, value=1653, value=...). An arrow connects the original strategy to the new one, illustrating how shrinking creates an entirely new structure rather than preserving the original one." id="" width="1280" height="660" loading="lazy"/><figcaption id=""><code id="">prop_flat_map</code> with a map from <em id="">x</em> to the strategy <em id="">0..x²</em>. Each time the original value is shrunk, a brand-new strategy is created (highlighted in red) and the shrinker has to start over.</figcaption></figure><p>Why is that the case? Consider what happens when we want to shrink a value through a <code>prop_flat_map</code>. As before:</p><ul><li>We would attempt to get a smaller value from the underlying value tree.</li><li>And then, because we would call the <code>prop_flat_map</code> callback to generate a new strategy, we would <em>throw away the previously-generated value tree entirely</em>.</li></ul><p>Because <code>prop_flat_map</code> generates brand new value trees each time it’s called, shrinking has to be started again, from scratch, each time! This is the essence of monadic composition: powerful, unconstrained, and fundamentally <strong>unpredictable</strong>.</p><h3 id="hL.WCag.measuring-the-impact">Measuring the impact<a href="#hL.WCag.measuring-the-impact" arialabel="Anchor" rel="nofollow noopener noreferrer">#</a></h3><p>We can measure the impact of monadic composition quite directly, along two related axes: the amount of time it takes to complete iterations, and the number of iterations the shrink completes in.</p><p>For this post I wrote <a href="https://github.com/sunshowers-code/proptest-shrink-tests" rel="nofollow noopener noreferrer">a small Rust program</a> which collects metrics about shrinking for:</p><ul><li>The <code>prop_flat_map</code> implementations for <code>BadType</code> pairs above, and a non-monadic implementation with <code>prop_map</code> (see below)</li><li>The same for <code>(BadType, BadType, BadType)</code> triples: a non-monadic implementation with <code>prop_map</code>, and a monadic one with two levels of <code>prop_flat_map</code>.</li></ul><p>With this program, I collected 512 samples on my workstation and analyzed the data. (I ran the program with <a href="https://doc.rust-lang.org/cargo/reference/profiles.html%23opt-level" rel="nofollow noopener noreferrer"><code>opt-level</code> set to 1</a>, to mimic typical dev builds in larger Rust projects<sup id="hL.WCag.fnref:4"><a href="#hL.WCag.fn:4" role="doc-noteref" rel="nofollow noopener noreferrer">4</a></sup>).</p><p>First, the amount of time it took to shrink values down, by key <a href="https://en.wikipedia.org/wiki/Percentile" rel="nofollow noopener noreferrer">percentile</a>:</p><div><table><thead><tr><th>Metric</th><th>Pairs (<code>prop_map</code>)</th><th>Triples (<code>prop_map</code>)</th><th>Pairs (<code>prop_flat_map</code>)</th><th>Triples (<code>prop_flat_map</code>)</th></tr></thead><tbody><tr><td><strong>min</strong></td><td>11 µs</td><td>48 µs</td><td>3.85 ms</td><td>8.95 ms</td></tr><tr><td><strong>p50</strong></td><td>1.70 ms</td><td>2.52 ms</td><td>8.52 ms</td><td>181 ms</td></tr><tr><td><strong>p75</strong></td><td>3.74 ms</td><td>5.77 ms</td><td>10.04 ms</td><td>307 ms</td></tr><tr><td><strong>p90</strong></td><td>5.25 ms</td><td>8.41 ms</td><td>11.76 ms</td><td>435 ms</td></tr><tr><td><strong>max</strong></td><td>7.00 ms</td><td>10.55 ms</td><td>15.53 ms</td><td>1808 ms</td></tr></tbody></table></div><p>In this table, <strong>p50</strong> represents the median completion time, while <strong>p75</strong> and <strong>p90</strong> show the times that 75% and 90% of the samples completed within. With <code>prop_map</code>, the amount of time scales somewhat linearly as we go from pairs to triples. But with just one additional level of <code>prop_flat_map</code>, the performance degrades dramatically, going from under 20 milliseconds to almost 2 seconds! That’s over 100x slower.</p><p>The difference in the number of iterations is even more striking:</p><div><table><thead><tr><th>Metric</th><th>Pairs (<code>prop_map</code>)</th><th>Triples (<code>prop_map</code>)</th><th>Pairs (<code>prop_flat_map</code>)</th><th>Triples (<code>prop_flat_map</code>)</th></tr></thead><tbody><tr><td><strong>min</strong></td><td>48</td><td>93</td><td>1228</td><td>11223</td></tr><tr><td><strong>p50</strong></td><td>215</td><td>306</td><td>6722</td><td>281016</td></tr><tr><td><strong>p75</strong></td><td>270</td><td>354</td><td>9315</td><td>481996</td></tr><tr><td><strong>p90</strong></td><td>310</td><td>410</td><td>10722</td><td>693358</td></tr><tr><td><strong>max</strong></td><td>387</td><td>530</td><td>12242</td><td>884729</td></tr></tbody></table></div><p>From hundreds of iterations to almost a million! And we’re working with pretty simple structures here, too. Just one more level of <code>prop_flat_map</code> would make shrinking quite noticeably slow, and another one after that would be disastrous.</p><p>The data here spans several orders of magnitude. A good way to visualize this kind of data is via a <a href="https://en.wikipedia.org/wiki/Cumulative_distribution_function" rel="nofollow noopener noreferrer">CDF</a> plotted on a logarithmic scale. In these graphs, the x-axis shows the time or iterations, and the y-axis shows the cumulative probability. Curves that are further to the right are worse, and the logarithmic scale reveals that the differences are in orders of magnitude.</p><figure id=""><img src="https://readeck.qauz.de/bm/Ls/Ls4P3Q3TgG1ppLpzbAKtfo/_resources/U95TgG86cSCKfMvTuoemcc.png" alt="There are two log‐log scale CDF (cumulative distribution function) plots, each showing four lines labeled “pair map,” “triple map,” “pair flat_map,” and “triple flat_map.” For the top plot (cdf of shrink execution time), the x‐axis ranges roughly from 10 µs to 1 × 10^6 µs (log scale) and the y‐axis shows cumulative probability from 0.01 to 1.0 (also log scale). The “pair map” (green) and “triple map” (purple) curves overlap around 100 µs to about 1,000 µs, reaching 100% probability before the “pair flat_map” (blue) and “triple flat_map” (orange) lines. The blue line peaks around tens of thousands of microseconds, while the orange line extends further toward 1 × 10^6 µs before leveling off. For the bottom plot (cdf of number of shrink iterations), the x‐axis is the number of iterations (10 to 1 × 10^6 on a log scale) and the y‐axis is cumulative probability (0.01 to 1.0 on a log scale). Again, “pair map” (green) and “triple map” (purple) are at lower iteration counts (roughly tens to hundreds) and reach 100% probability faster. “Pair flat_map” (blue) extends to thousands of iterations, and “triple flat_map” (orange) continues to tens or hundreds of thousands of iterations before reaching 100%. A legend in the top‐right corner identifies each line’s label. In the bottom right is system information (Ryzen 7950X, Linux 6.12, Rust 1.84.1, opt‐level 1)." id="" width="1280" height="853" loading="lazy"/><figcaption id="">Cumulative distribution functions for <code id="">prop_map</code> and <code id="">prop_flat_map</code> pairs and triples. This is a logarithmic scale, so the differences are in orders of magnitude.</figcaption></figure><h2 id="hL.WCag.5-rediscovering-structure">5. Rediscovering structure<a href="#hL.WCag.5-rediscovering-structure" arialabel="Anchor" rel="nofollow noopener noreferrer">#</a></h2><p>What makes monadic composition so difficult to deal with? It has to do with the fact, mentioned above, that you can write <em>whatever you like</em> inside the <code>prop_flat_map</code>. Because a <code>prop_flat_map</code> can contain arbitrary computation inside of it, and that computation returns brand-new strategies, determining how a value will shrink through it is fundamentally unpredictable without actually executing it.</p><p>In other words, the <code>prop_flat_map</code> callback is quite opaque. Why is that? It’s because the <code>prop_flat_map</code> callback is written in Rust, which is a powerful, <a href="https://en.wikipedia.org/wiki/Turing_completeness" rel="nofollow noopener noreferrer">Turing-complete</a> language. It is impossible to fully analyze the semantics of Turing-complete languages<sup id="hL.WCag.fnref:5"><a href="#hL.WCag.fn:5" role="doc-noteref" rel="nofollow noopener noreferrer">5</a></sup>. (You might know this as the <a href="https://en.wikipedia.org/wiki/Halting_problem" rel="nofollow noopener noreferrer">halting problem</a>, or as <a href="https://en.wikipedia.org/wiki/Rice%27s_theorem" rel="nofollow noopener noreferrer">Rice’s theorem</a>.)</p><p>But the fact that some analysis requires solving the halting problem is merely the start of the discussion, not the end of it! There is a rich literature on how to find approximate solutions for problems that are otherwise insoluble due to Rice’s theorem. For shrinking, here are a few approaches that are known to work.</p><p>One option is to <strong>place limits</strong> on how long shrinking is done for. Note that <code>prop_flat_map</code> has no issues while generating values, just while shrinking them<sup id="hL.WCag.fnref:6"><a href="#hL.WCag.fn:6" role="doc-noteref" rel="nofollow noopener noreferrer">6</a></sup>. The proptest library itself sets limits on shrink iterations, particularly <a href="https://docs.rs/proptest/latest/proptest/test_runner/struct.Config.html%23structfield.max_flat_map_regens" rel="nofollow noopener noreferrer">across <code>prop_flat_map</code> instances</a>. This ensures that shrinking operations finish in a reasonable amount of time, even if they don’t produce minimal values.</p><p>A better option is to <strong>rewrite generators to not use monadic composition</strong>. For the example above, it’s not hugely difficult<sup id="hL.WCag.fnref:7"><a href="#hL.WCag.fn:7" role="doc-noteref" rel="nofollow noopener noreferrer">7</a></sup>:</p><div><pre tabindex="0"><code><span><span><span>fn</span> <span>better_generate_bad_type_pair</span><span>()</span><span> </span>-&gt; <span>impl</span><span> </span><span>Strategy</span><span>&lt;</span><span>Value</span><span> </span><span>=</span><span> </span><span>(</span><span>BadType</span><span>,</span><span> </span><span>BadType</span><span>)</span><span>&gt;</span><span> </span><span>{</span><span>
</span></span></span><span><span><span>    </span><span>// Generate two BadType instances.
</span></span></span><span><span><span>    </span><span>(</span><span>
</span></span></span><span><span><span>        </span><span>generate_bad_type</span><span>(),</span><span>
</span></span></span><span><span><span>        </span><span>generate_bad_type</span><span>(),</span><span>
</span></span></span><span><span><span>    </span><span>)</span><span>
</span></span></span><span><span><span>    </span><span>// Look, no prop_flat_map! This is non-monadic composition.
</span></span></span><span><span><span>    </span><span>.</span><span>prop_map</span><span>(</span><span>|</span><span>(</span><span>bad1</span><span>,</span><span> </span><span>mut</span><span> </span><span>bad2</span><span>)</span><span>|</span><span> </span><span>{</span><span>
</span></span></span><span><span><span>        </span><span>// Add bad1.value to bad2.value. Because the two are non-negative
</span></span></span><span><span><span>        </span><span>// (unsigned integers), this ensures that bad2.value is always
</span></span></span><span><span><span>        </span><span>// bigger than bad1.value.
</span></span></span><span><span><span>        </span><span>bad2</span><span>.</span><span>value</span><span> </span><span>+=</span><span> </span><span>bad1</span><span>.</span><span>value</span><span>;</span><span>
</span></span></span><span><span><span>        </span><span>(</span><span>bad1</span><span>,</span><span> </span><span>bad2</span><span>)</span><span>
</span></span></span><span><span><span>    </span><span>})</span><span>
</span></span></span><span><span><span>}</span><span>
</span></span></span></code></pre></div><p>But this can be quite challenging as complexity goes up! The proptest library comes with a number of helpers to write non-monadic strategies, particularly <a href="https://docs.rs/proptest/latest/proptest/strategy/trait.Strategy.html%23method.prop_recursive" rel="nofollow noopener noreferrer"><code>prop_recursive</code></a> and <a href="https://docs.rs/proptest/latest/proptest/sample/struct.Index.html" rel="nofollow noopener noreferrer"><code>sample::Index</code></a>. But there are real situations, particularly with large and complex data structures (for example, randomly-generated programming language syntax trees), where none of those options suffice and you have to use the full power of <code>prop_flat_map</code>.</p><p>Last but not least, there’s a set of approaches that I’m going to put into the bucket of <em>rediscovering structure</em> across flat maps. Key to these is understanding that when you generate a random value, you’re turning an RNG, which is a random stream of bits, into concrete, structured values. Can we somehow be clever about looking at the RNG bitstream?</p><ul><li><p>One option is to <strong>instrument the test</strong>, for example by using a <a href="https://github.com/rust-fuzz/cargo-fuzz" rel="nofollow noopener noreferrer">fuzzer</a>. Fuzzing is all about generating random data, looking at the branches explored, and tweaking the random data to ensure other branches are taken. It’s a great fit for peering past the black box of monadic composition.</p></li><li><p>Another option is to <strong>be clever with random number generator</strong>. A random number ultimately generates a sequence of ones and zeroes. Can we poke at this sequence, possibly with the help of some hints from the strategies themselves? This is implemented by the <a href="https://github.com/HypothesisWorks/hypothesis" rel="nofollow noopener noreferrer">Hypothesis framework for Python</a>; see <a href="https://www.doc.ic.ac.uk/~afd/papers/2020/ECOOP_Hypothesis.pdf" rel="nofollow noopener noreferrer">this excellent paper about it</a>.</p></li></ul><p>Both of these approaches are heuristic and quite complex. But that’s what you need to put together some structure again, after it’s been through the blender of monadic composition.</p></div><p>In this article, we looked at monads as a <em>design pattern</em>: a way for a user to compose operations within a framework. We looked at both monadic functions like <code>prop_flat_map</code>, and non-monadic ones such as <code>prop_map</code> and <code>prop_oneof</code>. Finally, we saw how in the context of property-based testing, monadic composition has a performance impact measured in orders of magnitude.</p><p>With this knowledge in mind, you can now spot monadic composition in all kinds of other places:</p><p>The common thread through all of these examples is that within a framework, monadic composition is not just from value to <em>value</em>. It is from value to a further instance of that <em>framework</em>. The return value of <code>future.await</code> can result in more futures being spawned, monadic build nodes can generate more build nodes, and <code>flat_map</code> turns individual values into iterators. This freedom is what makes monads both the most flexible kind of composition, and the hardest to predict the behavior of.</p><p>This is part of a general observation throughout programming, whenever there’s an interaction between two parties or two sides. The more restrictions there are on one side, the freer the other side is to do what it likes. Monadic composition is an extreme version of that: the most powerful and least constrained form of composition for the user, but the most difficult to deal with for the framework.</p><p>Whether you’re a user or a library designer, pay close attention to situations where your operations are monadic. They can provide a great deal of power, perhaps too much in some circumstances. If non-monadic operations are sufficient to help you achieve your goal, prefer them.</p><p><em>Thanks to <a href="https://infosec.exchange/@munin" rel="nofollow noopener noreferrer">Fiona</a> and <a href="https://cliffle.com/" rel="nofollow noopener noreferrer">Cliff Biffle</a> for reviewing drafts of this post. Any mistakes in it are my own.</em></p><p><em>Updated 2025-02-20: Clarified note about Turing completeness to indicate that it is not the composition itself that’s Turing-complete—it’s the language used to write the callback in that’s at issue.</em></p><p>This section contains some jargon, but it’s mostly here to satisfy the pedants who will inevitably Ctrl-F for “monad laws”. Please ignore this section if you didn’t get here through a search for that string.</p></section>
